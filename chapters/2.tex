\chapter{Internet 地址结构}
\section{引言}
本章介绍了 Internet 中使用的网络层地址，又称为IP 地址。我们讨论了如何为 Internet
中的设备分配地址，有助于路由可扩展性的地址层次结构分配方式，以及特殊用途的地址，
包括广播、组播和任播地址。我们还讨论了 IPv4 和 IPv6 地址结构和用途的区别。

连接到 Internet 的每个设备至少有一个IP地址。基于TCP/IP 协议的专用网络中使用的
设备也需要IP地址。在任何情况下，IP 路由器（见第5章）实现的转发程序使用IP地址来
识别流量去向。IP 地址也表示流量来源。IP地址在某些方面与电话号码相似，但最终用户通
常知道并直接使用电话号码，而IP地址通常被 Internet 中的DNS（见第11章）屏蔽在用户
视线之外，DNS让大多数用户使用名字而不是数字地址。当用户需要自己建立网络或 DNS
由于某种原因失效时，用户需要直接处理IP地址。为了了解 Internet 如何识别主机和路由
器，并在它们之间实现流量的交付，我们必须了解IP地址的作用。因此，我们对它们的管
理、结构和用途感兴趣。

当一台设备连接到全球性的Internet 时，为它们分配地址就必须经过协调，这样就不会
重复使用网络中的其他地址。对于专用网络，使用的IP地址必须经过协调，以避免在专用
网络中出现类似的重复。成组的IP 地址被分配给用户和组织。这些地址的拥有者再将它们
分配给设备，这通常根据某些“编号方案”进行。对于全球性的 Internet 地址，一个分层结
构管理实体帮助用户和服务提供商分配地址。个人用户通常由 Internet 服务提供商（ISP）分
配地址，通过支付费用来获得地址和执行路由。

\section{表示 IP 地址}
大多数 Internet用户熟悉IP 地址，并且了解最流行的地址类型：IPv4地址。这些地址
通常采用所谓的点分四组或点分十进制表示法，例如 165.195.130.107。点分四组表示法由
四个用点分隔的十进制数组成。每个这样的数字是一个非负整数，范围为［0，255］，代表
整个IP地址的四分之一。点分四组表示法是编写完整的IPv4 地址（一个用于 Internet 系
统的32位非负整数）的简单方式，它使用便捷的十进制数。在很多情况下，我们将关注这
种地址的二进制结构。很多 Internet 站点，例如 http://www.subnetmask.info 和 http://www.
subnetcalculator.com，包含用于IP 地址和相关信息之间格式转换的计算器。表2-1给出了几
个IPv4地址的例子，以及对应的二进制表示，供大家开始学习。

表2-1 用点分四组和二进制表示法写的IPv4 地址

点分四组表示

0.0.0.0

1.2.3.4

10.0.0.255

165.195.130.107

255.255.255.255

二进制表示

00000000 00000000 00000000 00000000

00000001 00000010 00000011 00000100

00001010 00000000 00000000 11111111

10100101 11000011 10000010 01101011

11111111 11111111

11111111

1111111

在IPv6中，地址的长度是128位，是IPv4地址长度的4倍。一般来说，大多数用户对

它不太熟悉。IPv6地址的传统表示方法是采用称为块或字段的四个十六进制数，这些被称为
块或字段的数由冒号分隔。例如，一个包含8个块的IPv6地址可写为 5f05:2000:80ad:5800：
0058:0800:2023:1d71。虽然不像用户熟悉的十进制数，但将十六进制数转换二进制更容
易。另外，一些已取得共识的IPv6地址简化表示法已被标准化\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}：

1. 一个块中前导的零不必书写。在前面的例子中，地址可写为5fO5:2000:80ad:5800：

58:800:2023:1d71。

2. 全零的块可以省略，并用符号：代替。例如，IPv6地址0:0:0:0:0:0:0:1可简写为：：1。

同样，地址 2001:0db8:0:0:0:0:0:2可简写为2001:db8：：2。为了避免出现歧义，一个IPv6地址
中符号：只能使用一次。

3.在IPv6格式中嵌入IPv4地址可使用混合符号形式，紧接着IPv4 部分的地址块的值

为ffff，地址的其余部分使用点分四组格式。例如，IPv6 地址：：ffff:10.0.0.1 可表示 IPv4 地址
10.0.0.1。它被称为IPv4 映射的IPV6地址。

4. IPv6地址的低32位通常采用点分四组表示法。因此，IPv6地址：0102:f001 相当于地

址：1.2.240.1。它被称为IPv4 兼容的IPv6地址。需要注意，IPv4兼容地址与IPv4 映射地址不
同；它们只是在能用类似IPv4地址的方式书写或由软件处理方面给人以兼容的感觉。这种地
址最初用于 IPv4 和 IPv6之间的过渡计划，但现在不再需要\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}。

表2-2介绍了一些IPv6地址的例子以及它们的二进制表示。

表2-2 IPv6地址和它的二进制表示的几个例子

十六进制表示

5f05:2000:80ad:5800:58:800:2023:1d71

：：1.2.240.1或：：102:f001

二进制表示

0101111100000101 0010000000000000

1000000010101101 0101100000000000

0000000001011000 0000100000000000

0010000000100011 0001110101110001

0000000000000000

0000000000000000

0000000000000000 0000000000000000

0000000000000000

0000000000000000

0000000000000000 0000000000000001

0000000000000000 0000000000000000

0000000000000000

0000000000000000

0000000000000000 0000000000000000

0000000100000010 1111000000000001

在某些情况下（例如表示一个包含地址的URL 时），IPv6地址中的冒号分隔符可能与其

他分隔符混淆，例如IP 地址和端口号之间使用的冒号。在这种情况下，用括号字符［和］包
围IPv6地址。例如，URL

http://［2001:0db8:85a3:08d3:1319:8a2e:0370:73441:443/

是指IPv6 主机 2001:0db8:85a3:08d3:1319:8a2e:0370:7344 中的端口号443使用HTTP、TCP
和IPv6协议。

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}提供的灵活性造成了不必要的混淆，这是因为能用多种方式表示相同的IPv6

地址。为了弥补这种情况，\href{https://www.rfc-editor.org/rfc/rfc5952}{[RFC5952]}制定了一些规则，以缩小选择范围，同时与\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}
保持兼容。这些规则如下：

1.前导的零必须压缩（例如，2001:0db8：：0022 变成 2001:db8：：22）。

Internet 地址结构

23

2.：只能用于影响最大的地方（压缩最多的零），但并不只是针对16位的块。如果多个

块中包含等长度的零，顺序靠前的块将被替换：。

3.a到f的十六进制数字应该用小写表示。

在大多数情况下，我们会遵守这些规则。

\section{基本的IP 地址结构}
IPv4 地址空间中有4294967296个可能的地址，而IPv6 的地址个数为

340 282 366 920 938 463 463 374 607 431 768 211 456

由于拥有大量地址（特别是IPv6），可以方便地将地址空间划分成块。IP地址可根据类型和
大小分组。大多数IPv4 地址块最终被细分为一个地址，用于识别连接 Internet 或某些专用的
内联网的计算机网络接口。这些地址称为单播地址。IPv4地址空间中大部分是单播地址空间。
IPv6地址空间中大部分目前未使用。除了单播地址，其他类型的地址包括广播、组播和任播
地址，它们可能涉及多个接口，还有一些特殊用途的地址，我们将在后面讨论它们。在开始
介绍当前地址结构的细节之前，理解IP地址的历史演变是有用的。

\subsection{分类寻址}
当最初定义Internet 地址结构时，每个单播IP地址都有一个网络部分，用于识别接口使

用的IP 地址在哪个网络中可被发现；以及一个主机地址，用于识别由网络部分给出的网络
中的特定主机。因此，地址中的一些连续位称为网络号，其余位称为主机号。当时，大多数
主机只有一个网络接口，因此术语接口地址和主机地址有时交替使用。

现实中的不同网络可能有不同数量的主机，每台主机都需要一个唯一的IP 地址。一种

划分方法是基于当前或预计的主机数量，将不同大小的IP 地址空间分配给不同的站点。地
址空间的划分涉及五大类。每类都基于网络中可容纳的主机数量，确定在一个32位的 IPV4
地址中分配给网络号和主机号的位数。图2-1显示了这个基本思路。

类

15 16

31

A

网络号

1（8位；7位自由）

主机（24位）

B

网络号（16位；14位自由）

主机（16位）

C

网络号（24位；21位自由）

主机（8位）

D

组播地址（32位；28位自由）

E

保留（32位；28位自由）

图2-1 IPv4地址空间最初分为五大类。A、B、C类用于为Internet（单播地址）中的接口分配地址，
以及其他一些特殊情况下使用。类由地址中的头几位来定义：0为A类，10为B类，110为C

类等。D 类地址供组播使用（见第9章），E类地址保留

这里，我们看到5个类被命名为A、B、C、D和E。A、B、C类空间用于单播地址。

如果我们仔细看这些地址结构，可看到不同类的相对大小，以及在实际使用中的地址范围。
表2-3给出了这种类结构（有时被称分类地址结构）。

表 2-3

最初（“分类”）的IPv4地址空间划分

类

A

B

C

D

E

地址范围

0.0.0.0~ 127.255.255.255

128.0.0.0~191.255.255.255

192.0.0.0~ 223.255.255.255

224.0.0.0~ 239.255.255.255

240.0.0.0 ~255.255.255.255

高序位

用途

百分比

0

单播/特殊

1/2

10

单播/特殊

1/4

110

单播/特殊

1/8

1110

组播

1/16

1111

保留

1/16

网络数

128

16384

2 097 152

N/A

N/A

主机数

16 777 216

65 536

256

N/A

N/A

该表显示了分类地址结构的主要使用方式，如何将不同大小的单播地址块分配给用
户。类划分基于给定大小的可用网络数和给定网络中的可分配主机数之间的折中。例如，某
个站点分配了一个A类网络号18.0.0.0（MIT），其中有224个地址分配给主机（即IPV4地
址使用范围 18.0.0.0~18.255.255.255），但在整个 Internet 中只有127个A类网络。某个
站点分配了一个C类网络号，例如 192.125.3.0，只能容纳256台主机（也就是说在范围
192.125.3.0 ~ 192.125.3.255内），但有超过200万的C类网络号是可用的。

\begin{tcolorbox}
    这些数字是不准确的。有几个地址通常不作为单播地址使用。特别是，地址
    块中的第一个和最后一个地址通常不使用。在我们的例子中，站点分配的地址块为
    18.0.0.0，实际能分配多达2“-2=16777214个单播IP地址。
\end{tcolorbox}

Internet 地址分类方法在经历 Internet 增长（20世纪80年代）的第一个十年中没有变化。
此后，它开始出现规模问题，当每个新的网段被添加到 Internet 中，集中协调为其分配一个
新的A类、B类或C类网络号变得很不方便。另外，A类和B类网络号通常浪费太多主机号，
而C类网络号不能为很多站点提供足够的主机号。

\subsection{子网寻址}
Internet 发展初期首先遇到一个困难，那就是很难为接人 Internet 的新网段分配一个新的
网络号。在20世纪80年代初，随着局域网（LAN）的发展和增加，这个问题变得更棘手。
为了解决这个问题，人们很自然想到一种方式，在一个站点接人Internet 后为其分配一个网
络号，然后由站点管理员进一步划分本地的子网数。在不改变 Internet 核心路由基础设施的
情况下解决这个问题将会更好。

实现这个想法需要改变一个IP地址的网络部分和主机部分的限制，但这样做只是针对
一个站点自身而言；Internet 其余部分将只能“看到” 传统的A类、B类和C类部分。支持
此功能的方法称为子网寻址\href{https://www.rfc-editor.org/rfc/rfc0950}{[RFC0950]}。通过子网寻址，一个站点被分配一个A类、B类或
C类的网络号，保留一些剩余主机号进一步用于站点内分配。该站点可能将基础地址中的主
机部分进一步划分为一个子网号和一个主机号。从本质上来说，子网寻址为IP地址结构增
加了一个额外部分，但它没有为地址增加长度。因此，一个站点管理员能在子网数和每个子
网中预期的主机数之间折中，同时不需要与其他站点协调。

子网寻址提供额外灵活性的代价是增加成本。由于当前的子网字段和主机字段的定义是
由站点指定的（不是由网络号分类决定），一个站点中所有路由器和主机需要一种新的方式，
以确定地址中的子网部分和其中的主机部分。在出现子网之前，这个信息可直接从一个网络
号中获得，只需知道是A类、B类或C类地址（由地址的前几位表示）。图2-2给出了使用
子网寻址的例子，显示了一个 IPv4地址可能的格式。

集中分配

站点本地管理

类

B

15 16

31

网络号（16位；14位自由）

子网ID（8位）

主机ID（8位）

子网/主机部分

图2-2一个B类地址被划分子网的例子。它使用8位作为子网ID，提供256个子网和每个子网中
254 台主机。这种划分可由网络管理员改变

图2-2是一个B类地址被“划分子网”的例子。假设 Internet 中的一个站点已被分配一
个B类网络号。该站点将每个地址的前16位固定为某些特定号码，这是由于这些位已被分
配给核心机构。后16位（仅用于在无子网的B类网络中创建主机号）现在可以由站点的网
络管理员按需分配。在这个例子中，8位被选定为子网号，剩下8位为主机号。这个特殊配
置允许站点支持256个子网，每个子网最多可包含254台主机（当前每个子网的第一个和最
后一个地址无效，即从整个分配范围中除去第一个和最后一个地址）。注意，只有划分子网
的网络中的主机和路由器知道子网结构。在需要进行子网寻址之前，Internet 其他部分仍将
它作为站点相关的地址来看待。图2-3显示了如何工作。

Internet

137.164.23.30

前往或来自128.32.x.X

的所有流量

128.32.2.9

站点边界

路由器

128.32.1.X

128.32.2.×

128.32.1.1

站点范围子网掩码

255.255.255.0

图 2-3

128.32.1.14

128.32.2.122

某个站点被分配一个典型的B类网络号 128.32。网络管理员决定用于站点范围内的子网掩码

为255.255.255.0，提供256 个子网，每个子网可容纳256-2=254台主机。同一子网中每台

主机的IPv4地址拥有相同子网号。左侧的局域网段中主机的IPv4地址开始于 128.32.1，右侧

的所有主机开始于 128.32.2

本图显示了一个虚拟的站点，使用一个边界路由器（即 Interet 的一个连接点）连接

Internet 和两个内部局域网。x 的值可以是「0.2551范围内的任意值。每个以太网是一个IPv4
子网，整体分配B类地址的网络号 128.32。Internet 中的其他站点要访问这个站点，目的
地址以128.32开始的所有流量直接由 Internet 路由系统交给边界路由器（特别是其接口的
IPv4 地址137.164.23.30）。在这点上，边界路由器必须区分128.32网络中的不同子网。特别
是，它必须能区分和分离目的地址为128.32.1.x 和目的地址为128.32.2.x.的流量。这些地址
分别表示子网号1和2，它们都采用128.32的B类网络号。为了做到这点，路由器必须知道
在地址中如何找到子网ID。这可通过一个配置参数实现，我们将在后面加以讨论。

\subsection{子网掩码}
子网掩码是由一台主机或路由器使用的分配位，以确定如何从一台主机对应IP地址中

获得网络和子网信息。IP 子网掩码与对应的IP地址长度相同（IPv4为32位，IPv6 为128
位）。它们通常在一台主机或路由器中以IP 地址相同的方式配置，既可以是静态的（通常
是路由器），也可以使用一些动态方式，例如动态主机配置协议（DHCP；见第6章）。对于
IPv4，子网掩码以IPv4 地址相同的方式（即点分十进制）编写。虽然最初不需要以这种方
式分配，当前子网掩码由一些1后跟一些0构成。这样安排，就可以用容易记的格式表示掩
码，只需给出一些连续位的1（左起）的掩码。这种格式是当前最常见的格式，有时也被称
为前缀长度。表2-4列出了IPv4的一些例子。

点分十进制表示

128.0.0.0

255.0.0.0

255.192.0.0

255.255.0.0

255.255.254.0

255.255.255.192

255.255.255.255

表2-4 各种格式的IPv4 子网掩码的例子

容易记的格式（前缀长度）

/1

/8

/10

/16

/23

127

/32

二进制表示

10000000 00000000 00000000 00000000

11111111 00000000 00000000 00000000

11111111 11000000 00000000 00000000

111

00000000 00000000

110 00000000

1100000

11111

表2-5列出了IPv6的一些例子。

十六进制表示

表2-5 各种格式的IPv6子网掩码的例子

容易记的格式（前缀长度）

ffff:ffff:ffff:ffff：：

164

ffO0：：

18

11111111

二进制表示

111 11111111

11111111

11111111

1111111

11111

0000000000000000 0000000000000000

0000000000000000 0000000000000000

1111111100000000 0000000000000000

0000000000000000 0000000000000000

0000000000000000 0000000000000000

0000000000000000 0000000000000000

掩码由路由器和主机使用，以确定一个 IP 地址的网络/子网部分的结束和主机部分的开

始。子网掩码中的一位设为1表示一个IP地址的对应位与一个地址的网络/子网部分的对应
位相结合，并将结果作为转发数据报的基础（见第5章）。相反，子网掩码中的一位设为0，
表示一个IP 地址的对应位作为主机ID 的一部分。例如，我们在图2-4中可以看到，当子网
掩码为 255.255.255.0时，如何处理 IPv4 地址 128.32.1.14。

Internet 地址结构

27

地址

掩码

结果

=0 01.0。 。.0000n

00001110

11111111 11 11111 11111111

00000000

10000000 00100000 00000001 00000000

128.32.1.14

255.255.255.0（/24）

128.32.1.0

图2-4一个IP 地址可以与一个子网掩码使用按位与操作，以形成用于路由的地址的网络/子网标识符
（前缀）。在这个例子中，IPv4地址128.32.1.14使用长度为24的掩码得到前缀 128.32.1.0/24

这里，我们看如何将地址中的每位与子网掩码中的对应位进行与运算。回顾按位与运

算，如果掩码和地址中的对应位都是1，则结果位都只能是1。在这个例子中，我们看到地
址128.32.1.14 属于子网 128.32.1.0/24。图2-3中是边界路由器需要的信息，以确定一个目的
地址为 128.32.1.14的数据报需要转发到的系统所在的子网。注意，Internet 路由系统其余部
分不需要子网掩码的知识，因为站点之外的路由器做出路由决策只基于地址的网络号部分，
并不需要网络/子网或主机部分。因此，子网掩码纯粹是站点内部的局部问题。

\subsection{可变长度子网掩码}
目前止，我们已讨论如何将一个分配给站点的网络号进一步细分为多个可分配的大小

相同的子网，并根据网络管理员的合理要求使每个子网能支持相同数量的主机。我们发现在
同一站点的不同部分，可将不同长度的子网掩码应用于相同网络号。虽然这样增加了地址配
置管理的复杂性，但也提高了子网结构的灵活性，这是由于不同子网可容纳不同数量的主机。
目前，大多数主机、路由器和路由协议支持可变长度子网掩码（VLSM）。要了解 VLSM如何
工作，可以看图2-5所示的网络拓扑，它使用 VLSM为图2-3扩展了两个额外的子网。

Internet

137.164.23.30/32

128.32.1.1/24

前往或来自128.32.x.X

的所有流量

（128.32.0.0/16）

.128.32.2.9/24

128.32.1.×

（128.32.1.0/24）

站点边界

路由器

128.32.2.X

（128.32.2.0/24）

128.32.230.129/26

128.32.1.14/24

内部路由器

128.32.2.126/24

128.32.230.｛128~191｝

（128.32.230.128/26）

128.32.2.129/25

128.32.2.130/25

128.32.2.｛128~255｝

（128.32.2.128/25）

图2-5 VLSM 可用于分割一个网络号，使每个子网支持不同数量的主机。每个路由器和主机除了IP地址，
还需要配置一个子网掩码。大多数软件支持 VLSM，除了一些旧的路由协议（例如 RIP版本1）

在图2-5显示的更复杂的例子中，三个不同的子网掩码被用于站点中的子网128.32.0.0/16：

/24、/25 和/26。这样，每个子网可提供不同数量的主机。主机数受IP地址中没有被网络/子
网号使用的剩余位限制。对于IPv4 和/24前缀，允许有32-24=8位（256台主机）；对于125，
有1/2数量（128台主机）；对于/26，有1/4数量（64台主机）。注意，主机和路由器的每个接
口都需要用 IP地址和子网掩码来描述，但掩码决定了网络拓扑的不同。基于路由器中运行的
动态路由协议（例如 OSPF、IS-IS、RIPv2），流量能正确地在同一站点中的主机之间流动，
以及通过 Internet 前往或来自外部站点。

尽管这可能并不显而易见，但有一个常见情况，即一个子网中只包含两台主机。当路由

器之间被一条点到点链路连接，则每个端点都需要分配一个 IP 地址，常见做法是IPv4使用
/31为前缀，目前也有建议 IPv6 使用/127为前缀\href{https://www.rfc-editor.org/rfc/rfc6164}{[RFC6164]}。

\subsection{广播地址}
在每个IPv4子网中，一个特殊地址被保留作为子网广播地址。子网广播地址通过将

IPv4 地址的网络/子网部分设置为适当值，以及主机部分的所有位设置1而形成。我们看
图2-5中最左边的子网，它的前缀是128.32.1.0/24。子网广播地址的构建方式为：对子网掩
码取反（即将所有的0位改变为1，反之亦然），并与子网中任意计算机的地址（或等值的网
络/子网前缀）进行按位或运算。注意，如果两个输人位之一为1，按位或运算的结果为1。
图2-6显示了这个计算过程，其中使用 IPv4 地址128.32.1.14。

地址

15 16

31

10000000 00100000 00000001

00001110

128.32.1.14

掩码取反

00000000 00000000 00000000

11111111

0.0.0.255

或的结果

10000000 00100000 00000001

11111111

128.32.1.255

图2-6 子网广播地址由子网掩码首先取反，然后与IPv4地址进行或运算构建而成。在这种情况下，
一个/24的子网掩码，剩余的32-24=8位设置为1，得到一个十进制值255 和子网广播地址

128.32.1.255

如图2-6所示，子网128.32.1.0/24的子网广播地址是128.32.1.255。从历史上看，使用

这种地址作为目的地的数据报，也被称为定向广播。至少在理论上，这种广播可作为一个单
独的数据报通过 Internet 路由直至到达目标子网，再作为一组广播数据报发送给子网中所有
主机。对这个想法做进一步概括，我们可形成一个目的IPv4 地址为128.32.255.255 的数据
报，并且通过图2-3或图2-5所示的连接网络将它发送到Internet。这时，该数据报将发送给
目标站点中的所有主机。

注意 定向广播是一个大问题，从安全的角度来看，它们至今在 Internet 中仍被禁

用。\href{https://www.rfc-editor.org/rfc/rfc0919}{[RFC0919]} 描述了针对IPv4的各类广播，\href{https://www.rfc-editor.org/rfc/rfc1812}{[RFC1812]}建议支持由路由器转发

定向广播，它不仅可用，而且默认启用。\href{https://www.rfc-editor.org/rfc/rfc2644}{[RFC2644]}使这个策略发生逆转，路由器

现在默认禁止转发定向广播，甚至完全省略支持能力。

除了子网广播地址，特殊用途地址 255.255.255.255被保留为本地网络广播（也称为有限

Internet 地址结构

29

广播），它根本不会被路由器转发（详见 2.5节中的特殊用途地址）。注意，虽然路由器可能
不转发广播，但子网广播和连接在同一网络中的计算机的本地网络广播将工作，除非被终端
主机明确禁用。这种广播不需要路由器；如果有的话，链路层的广播机制用于支持它们（见
第3章）。广播地址通常与某些协议一起使用，例如UDP/IP（第10章）或ICMP（第8章），
因为这些协议不涉及TCPAIP 那样的双方会话。IPv6没有任何广播地址；广播地址可用于
IPv4 中，而IPv6仅使用组播地址（见第9章）。

\subsection{IPv6地址和接口标识符}
除了比IPv4地址长4倍这个因素，IPv6地址还有一些额外的特点。IPv6地址使用特殊

前缀表示一个地址范围。一个IPv6地址范围是指它可用的网络规模。有关范围的重要例子
包括节点本地（只用于同一计算机中通信）、链路本地（只用于同一网络链路或IPv6 前缀中
的节点）或全球性（Internet范围）。在IPv6 中，大部分节点通常在同一网络接口上使用多个
地址。虽然IPv4 中也支持这样做，但是并不常见。一个IPv6节点中需要一组地址，包括组
播地址（见2.5.2节），它来源于\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}。

注意 另一个范围层次称 站点本地，使用的前缀 fec0:/10，最初是由IPV6支

持的，后来被\href{https://www.rfc-editor.org/rfc/rfc3879}{[RFC3879]}放弃并用于单播地址。主要问题包括如何处理这种地址，

这是由于它可能被重用于多个站点，以及如何准确定义一个“站点”。

链路本地IPv6地址（和一些全球性IPv6地址）使用接口标识符（IID）作一个单播

IPv6地址的分配基础。除了地址是以二进制值000开始之外，ID 在所有情况下都作为一个
IPv6地址的低序位，这样它们必须在同一网络中有唯一前缀。IID 的长度通常是64位，并直
接由一个网络接口相关的链路层 MAC地址形成，该地址使用修改的 EUI-64 格式［EUI64］，
或者由其他进程随机提供的值形成，以提供可防范地址跟踪的某种程度的隐私保护（见
第6章）。

在IEEE 标准中，EUI表示扩展唯一标识符。EUI-64标识符开始于一个24位的组织唯

一标识符（OUI），接着是一个由组织分配的40位扩展标识符，它由前面24位识别。OUI 由
IEEE 注册权威机构［IEEBRA］来维护和分配。EUI 可能是“统一管理”或“本地管理”的。
在 Internet 环境下，这种地址通常是统一管理的。

多年来，很多IEEE 标准兼容的网络接口（例如以太网）在使用短格式的地址（48位的

EUI）。EUI-48 和 EU1-64格式之间的显著区别是它们的长度（见图2-7）。

0

s

EU1-48

u：通用/本地

EUI-64

g：个人/组

7

OUI（24位）

由组织分配

图2-7 EU1-48 和 EUI-64格式由IEEE定义。这些都是用于IPv6 的地址，

它们是通过将接口标识符取反u位来形成的

OUI 的长度是24位，并占据EUI-48 和 EUI-64地址的前3个字节。这些地址的第一个

字节的低两位分别是u位和g位。当u位被设置时，表示该地址是本地管理。当g位被设置
时，•表示该地址是一组或组播类型的地址。目前，我们只关心g位未被设置的情况。

一个EUI-64地址可以由EUI-48地址形成，将 EUI-48地址的24位OUI 值复制到 EUI-

64地址，并将 EU1-64地址的第4和第5个字节的16位替換 1111111111111110（十六进
制 FFFE），然后复制由组织分配的剩余位。例如，EUI-48地址 00-11-22-33-44-55 在 EUI-
64 地址中将会变成 00-11-22-FF-FE-33-44-55。这个映射的第一步是当可以用基本EU1-48地
址时由IPv6构造接口标识符。修改的EUI-64用于形成IPv6地址的IID，但是需要对u位
取反。

当一个IPv6接口标识符需要一种接口，并且该接口没有由制造商提供EUI-48地址，但

是有其他类型的基本地址时（例如 AppleTalk），基本地址可用0从左侧填充形成接口标识符。
当接口标识符是为缺乏任意形式标识符的接口（例如隧道、串行链路）创建时，它可由相同
节点上（不在同一子网中）的其他接口，或者与节点有关联的某些标识符派生。在缺乏其他
选择的情况下，手动分配是最后的方案。

\subsubsection{例子}
我们探讨使用 Linux 的ifconfig 命令形成一个链路本地IPv6地址的方式：

Linux* ifconfig eth1

eth1

Link encap:Ethernet

inet addr:12.46.129.28

HWaddr 00:30:48:2A:19:89

Bcast:12.46.129.127

Mask:255.255.255.128

inet6 addr: fe80：：230:48ff:fe2a:1989/64 Scope:Link

UP BROADCAST RUNNING

MULTICAST

MTU:1500

Metric:1

RX packets: 1359970341 errors:0 dropped:0 overruns:0

frame:0

TX packets:1472870787 errors:0 dropped:0 overruns:0 carrier:0

collisions:0 txgueuelen:1000

RX bytes:4021555658 （3.7 GiB）

TX bytes: 3258456176（3.0 GiB）

Base address :0x3040 Memory:f8220000-f8240000

这里，我们可看到以太网硬件地址00:30:48:2A:19:89如何被映射为一个IPv6地址。

首先，它被转换为EUI-64形成地址 00:30:48:ff:fe:2a:19:89。接着，u位被取反，形成IID
值 02:30:48:ff:fe:2a:19:89。为了完成链路本地IPv6地址，我们使用保留的链路本地前缀
fe80:/10（见2.5节）。总之，这样形成完整地址 fe80：：230:48ff:fe2a:1989。/64是标准长度，用
于从一个 IPv6地址中识别子网/主机部分，它由 \href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}要求的一个 IID 派生。

另一个有趣的例子来自支持IPv6的Windows 系统。在这个例子中，我们将看到一个特

殊的隧道端点，它被用于使IPv6流量通过仅支持IPv4的网络：

c：> ipcontig /a11

runnel adapter Automatic Tunneling

Pseudo-Interface：

Connection-specific

DNS

Description

Suffix

•： foo

：

Automatic runneling

Pseudo-Interface

Physical Address.

Dhcp Enabled.

IP Address.

Default Gateway

DNS

Servers

：

0A-99-8D-87

No

fe80：：5efe:10.153.141.13582

fecO:0:0:ffff：：182

Internet 地址结构

J/

NetBIOS over Tcpip. •

fecO:0:0:ffff：：282

fecO:0:0:ffff：：382

： Disabled

•••

在这个例子中，我们可以看到一个特的隧道接口为ISATAP\href{https://www.rfc-editor.org/rfc/rfc5214}{[RFC5214]}。实际上，所

谓的物理地址是IPv4地址的十六进制编码：0A-99-8D-87与10.153.141.135相同。这里，使
用的OUI（00-00-5E）是由IANA分配的［IANA］。它被用于与十六进制值 fe 组合，表示一
个嵌人的IPv4地址。然后，这个组合与标准的链路本地前缀fe80：：/10组合，最终形成地址
fe80：：5efe:10.153.141.135。附加在地址结尾的%2 在Windows 中称为区域ID，表示主机中
对应于 IPv6地址的接口索引号。IPv6地址通常由一个自动配置过程创建，我们在第6章详
细讨论这个过程。

\section{CIDR 和聚合}
20世纪90年代初，在采用子网寻址缓解增长带来的痛苦后，Internet 开始面临更严重的

规模问题。有三个问题很重要，需要立即引起注意：

1.到1994年，一半以上的B类地址已被分配。预计，B类地址空间大约在1995年将被

用尽。

\section{位的IPv4地址被认为不足以应付 Internet 在21世纪初的预期规模。}
3. 全球性路由表的条目数（每个网络号对应一条），1995年大约为65 000个条目，目前

仍在增长中。随着越来越多A类、B类和C类路由条目的出现，路由性能将受到影响。

从1992年开始，这些问题受到IETF 中的ROAD（路由和寻址）小组的关注。他们认为

问题1和3将很快来临，问题2需要一个长期的解决方案。他们提出的短期解决方案是有效
清除IP地址的分类缺陷，并提高层次化分配的IP地址的聚合能力。这些措施将有助于解决
问题1和3。IPv6被设想用于解决问题2。

\subsection{前缀}
为了帮助缓解IPv4地址（特别是B类地址）的压力，分类寻址方案通常使用一个类似

VLSM 的方案，扩展 Internet 路由系统以支持无类别域间路由（CIDR）\href{https://www.rfc-editor.org/rfc/rfc4632}{[RFC4632]}。这提供
了一种方便的分配连续地址范围的方式，包含多于255台但少于65 536台主机。也就是说，
不只是单个B类或多个C类网络号可分配给站点。使用CIDR，未经过预定义的任何地址
范围可作为一个类的一部分，但需要一个类似于子网掩码的掩码，有时也称为CIDR 掩码。
CIDR 掩码不再局限于一个站点，而对全球性路由系统都是可见的。因此，除了网络号之外，
核心 Internet 路由器必须能解释和处理掩码。这个数字组合称为网络前缀，它用于 IPv4 和
IPv6地址管理。

消除一个 IP 地址中网络和主机号的预定义分隔，将使更细粒度的IP 地址分配范围成为

可能。与分类寻址类似，地址空间分割成块最容易通过数值连续的地址来实现，以便用于某
种类型或某些特殊用途。目前，这些分组普遍使用地址空间的前缀表示。一个n位的前缀是
一个地址的前n个位的预定义值。对于 IPv4，n（前缀长度）的值通常在范围0~32；对于
IPv6，通常在范围0~128。它通常被追加到基本IP 地址，并且后面跟着一个/字符。表2-6
给出了一些前缀的例子，以及相应的IPv4 或IPv6地址范围。

前缀

0.0.0.0/0

128.0.0.0/1

128.0.0.0/24

198.128.128.192/27

165.195.130.107/32

2001:db8：：/32

表2-6

前缀的例子及其相应的IPv4或IPv6地址范围

前缀（二进制）

00000000 00000000 00000000 00000000

［00000 00000000 00000000 00000000

10000000 00000000 00000000,00000000

11000110 10000000 10000000 11000000

10100101 11000011 10000010 01101011|

0010000000000001 0000110110111000

0000000000000000 0000000000000000

0000000000000000 0000000000000000

0000000000000000 0000000000000000

地址范围

0.0.0.0 ~ 255.255.255.255

128.0.0.0 ~ 255.255.255.255

128.0.0.0 ~ 128.0.0.255

198.128.128.192 ~ 198.128.128.223

165.195.130.107

2001:db8：~ 2001:db8:ffff:fff

在这个表中，由前缀来定义并固定的位被圈在一个框中。剩余位可设置为0和1的任意

组合，从而涵盖可能的地址范围。显然，一个较小的前缀长度可对应于一个更大的地址范围。
另外，早期的分类寻址方案易于被这个方案覆盖。例如，C类网络号192.125.3.0可以写成前
缀 192.125.3.0/24或 192.125.3/24。分类的A类和B类网络号可分别用前缀长度18和/16表示。
\section{.2}
聚合

通过取消分类结构的IP地址，能分配各种尺寸的IP 地址块。但是，这样做没有解决问

题列表中的第三个问题，它并没有帮助减少路由表条目数。一条路由表条目告诉一个路由器
向哪里发送流量。从本质上来说，路由器检查每个到达的数据报中的目的IP地址，找到一
条匹配的路由表条目，并从该条目中提取数据报的“下一跳”。这有点像驾驶汽车去一个特
定地址，并在沿路每个路口找到一个标志，指示沿着哪个方向去目的地路线的下一个路口。
如果你能理解在每个路口设置很多标志，以指向每个可能的目的地的情形，就能认识到20
世纪90年代初 Internet 面临的一些问题。

当时，没什么技术可以解决以下问题：在维护 Internet 中到所有目的地的最短路径的

同时，又能够显著减少路由表条目数。最有名的方法是20世纪70年代末由 Kleinrock 和
Kamoun 发表的分层路由研究［KK77］。他们发现，如果将网络拓扑排列为一棵树®

，并且以对

这个网络拓扑“敏感的”方式来分配地址，这样可获得一个非常小的路由表，同时保持到所
有目的地的最短路径。大家可以看图2-8。

在图2-8中，圆表示路由器，线表示它们之间的网络链路。图的左侧和右侧显示树状网

络。它们之间的区别是路由器的地址分配方式。在图2-8a 中，地址基本上是随机的，树中
的路由器地址和位置之间没有直接关系。在图2-8b 中，地址根据路由器在树中的位置分配。
如果考虑每个顶层路由器需要的条目数，就可以看到这是一个重大区别。

图2-8中左侧树的根（顶级）是标记为19.12.4.8的路由器。为了知道每个可能的目的地

的下一跳，它需要一个树中在其“下面的”所有路由器的条目：190.16.11.2、86.12.0.112、
159.66.2.231、133.17.97.12、66.103.2.19、18.1.1.1、19.12.4.9和 203.44.23.198。对于任何
其他目的地，它只需简单地路由到标有“网络其他部分”的云中。结果共有9个条目。相比
之下，右侧树的根被标记为19.0.0.1，并要求其路由表中只有3个条目。注意，右树中左侧
日 在图论中，一棵树是一个没有循环的连接图。对于一个网络中的路由器和链路，这意味着在任意两台路

器之间有且只有一条简单的（不重复的）路径。

Internet 地址结构

的所有路由器以前缀19.1 开始，右侧的所有路由器以前缀19.2开始。因此，路由器 19.0.0.1
的表中只需将以19.1开始的目的地显示下一跳为19.1.0.1，而将以19.2开始的目的地显示下
一跳为 19.2.0.1。任何其他目的地都被路由到标有“网络其他部分”的云中。结果共有3个
条目。注意，这种行为是递归的，图2-8b所示树中的任意路由器，需要的条目数都不会超过
它拥有的链路数。这是这种特殊的地址分配方法所带来的直接结果。即使越来越多的路由器
加入图2-8b所示的树，这个良好的属性也保持不变。这是［KK77］的分层路由思想的精髓。

网络其他部分

3个条日

（不随着树生长变化的表）

19.0.0.1

9个条目

（随着树生长增大的表）

19.12.4.8

190.16.11.2

66.103.2.19

86.12.0.112

133.17.97.12 19.1.0.1

19.2.0.1

19.2.3.1

18.1.1.1

•

19.1.1.1

19.2.1.1

159.66.2.231

19.12.4.9

203.44.23.198

19.1.1.65

19.2.1.65

19.2.3.254

a）随机（位置无关）寻址

b）拓扑敏感（位置相关）寻址

图2-8 在树状拓扑的网络中，网络地址可采用特殊方式分配，以限制需保存在路由器中的路由信息
（“状态”）数量。如果不以这种（左侧的）方式分配地址，没有存储与需到达的节点数量成正

比的状态，则最短路径无法得到保证。当以保存状态的树状拓扑敏感的方式分配地址时，如果

网络拓扑发生变化，通常需要重新分配地址

在 Internet 环境中，可采用分层路由思想以一种特定方式减少 Internet 路由条目数。这

通过一个称为路由聚合的过程来实现。通过将相邻的多个IP 前缀合并成一个短前缀（称一
个聚合或汇聚），可以覆盖更多地址空间。我们可以看图2-9。

190.154.27.0/26

几 190.154.27.0/25

190.154.27.64/26

190.154.27.192/26

190.134.27:193/280）

190.154.27.128/26

190.154.27.0/25

190.154.27.128/25

190.154.27.0/24

190.154.26.0/24

190.154.26.0/23

图2-9

在这个例子中，箭头表示将两个地址前缀聚合为一个，带下划线的前缀是每一步的结果。第一步，

190.154.27.0/26 和190.154.27.64.0/26可以聚合，这是由于它们数值相邻，但是190.154.27.192/26

不能聚合。通过与 190.154.27.128/26相加，它们可经过两步聚合形成 190.154.27.0/24。最后，通

过与相邻的190.154.26.0/24相加，生成聚合结果 190.154.26.0/23

首先看图2-9中左侧的三个地址前缀。前两个（190.154.27.0/26 和 190.154.27.64/26）

数值相邻，因此可被组合（聚合）。箭头表示聚合发生的地方。前缀190.154.27.192/26 不能
在第一步被聚合，由于它们并非数值相邻。当增加一个新前缀 190.154.27.128/26（下划线），
前缀190.154.27.192/26 和190.154.27.128/26 可能被聚合，并形成190.154.27.128/25前缀。
这个聚合现在与聚合190.154.27.0/25相邻，因此它们可进一步聚合成190.154.27.0/24。当增
加前缀190.154.26.0/24（下划线），两个C类的前缀可以聚合成190.154.26.0/23。这样，原来
的三个前缀和两个增加的前缀可聚合成一个前缀。

\section{特殊用途地址}
IPv4 和 IPv6地址空间中都包括几个地址范围，它们被用于特殊用途（因此不能用于单

播地址分配）。对于 IPv4，这些地址显示在表2-7中\href{https://www.rfc-editor.org/rfc/rfc5735}{[RFC5735]}。

前缀

0.0.0.0/8

10.0.0.0/8

127.0.0.0/8

169.254.0.0/16

172.16.0.0/12

192.0.0.0/24

192.0.2.0/24

192.88.99.0/24

192.168.0.0/16

198.18.0.0/15

198.51.100.0/24

203.0.113.0/24

224.0.0.0/4

240.0.0.0/4

表2-7 IPv4特殊用途地址（定义于2010年1月）

特殊用途

本地网络中的主机。仅作为源IP地址使用

专用网络（内联网）的地址。这种地址不会出现在公共 Internet 中

Internet 主机回送地址（同一计算机）。通常只用127.0.0.1

“链路本地”地址，只用于一条链路，通常自动分配。见第6章

专用网络（内联网）的地址。这种地址不会出现在公共 Internet 中

IETF 协议分配（IANA 保留）

批准用于文档中的 TEST-NET-1地址。这种地址不会出现在公共 Internet 中

用于 6to4 中继（任播地址）

专用网络（内联网）的地址。这种地址不会出现在公共 Internet 中

用于基准和性能测试

TEST-NET-2地址。被批准用于文档中

TEST-NET-3 地址。被批准用于文档中

IPv4 组播地址（以前的D类），仅作为目的IP地址使用

保留空间（以前的E类），除了255.255.255.255

255.255.255.255/32

本地网络（受限的）广播地址

参考文献

\href{https://www.rfc-editor.org/rfc/rfc1122}{[RFC1122]}

\href{https://www.rfc-editor.org/rfc/rfc1918}{[RFC1918]}

\href{https://www.rfc-editor.org/rfc/rfc1122}{[RFC1122]}

\href{https://www.rfc-editor.org/rfc/rfc3927}{[RFC3927]}

\href{https://www.rfc-editor.org/rfc/rfc1918}{[RFC1918]}

\href{https://www.rfc-editor.org/rfc/rfc5736}{[RFC5736]}

\href{https://www.rfc-editor.org/rfc/rfc5737}{[RFC5737]}

\href{https://www.rfc-editor.org/rfc/rfc3068}{[RFC3068]}

\href{https://www.rfc-editor.org/rfc/rfc1918}{[RFC1918]}

\href{https://www.rfc-editor.org/rfc/rfc2544}{[RFC2544]}

\href{https://www.rfc-editor.org/rfc/rfc5737}{[RFC5737]}

\href{https://www.rfc-editor.org/rfc/rfc5737}{[RFC5737]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc1112}{[RFC1112]}

\href{https://www.rfc-editor.org/rfc/rfc0919}{[RFC0919]}

\href{https://www.rfc-editor.org/rfc/rfc0922}{[RFC0922]}

在IPv6 中，许多地址范围和个别地址用于特定用途，它们都列在表2-8中\href{https://www.rfc-editor.org/rfc/rfc5156}{[RFC5156]}。

前缀

表2-8 IPv6 特殊用途地址（定义于2008年4月）

特殊用途

：：/0

：：/128

：：1/128

：：ffff:0:0/96

：｛ipv4-address｝/96

2001：：/32

2001:10：：/28

2001:db8：：/32

2002：：/16

3ffe：：/16

5f00：：/16

fc00：：/7

fe80：：/10

ff00：：/8

默认路由条目。不用于寻址

未指定地址，可作为源IP地址使用

IPv6 主机回送地址，不用于发送出本地主机的数据报中

IPv4 映射地址。这种地址不会出现在分组头部，只用于内部主机

IPv4 兼容地址。已过时，未使用

Teredo 地址

ORCHI（覆盖可路由加密散列标识符）。这种地址不会出现在公共 Internet 中

用于文档和实例的地址范围。这种地址不会出现在公共 Internet 中

6to4 隧道中继的6to4 地址

用于 6bone 实验。已过时，未使用

用于 6bone 实验。已过时，未使用

唯一的本地单播地址，不用于全球性的 Internet

链路本地单播地址

IPv6组播地址，仅作为目的IP 地址使用

参考文献

\href{https://www.rfc-editor.org/rfc/rfc5150}{[RFC5150]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4380}{[RFC4380]}

\href{https://www.rfc-editor.org/rfc/rfc4843}{[RFC4843]}

［RFC3849」

\href{https://www.rfc-editor.org/rfc/rfc3056}{[RFC3056]}

［RFC370L］

\href{https://www.rfc-editor.org/rfc/rfc3701}{[RFC3701]}

\href{https://www.rfc-editor.org/rfc/rfc4193}{[RFC4193]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

Internet 地址结构

对于 IPv4 和IPv6，没有指定作为特殊、组播或保留地址的地址范围可供单播使用。一

些单播地址空间（IPv4 的前缀10/8、172.16/12 和 192.168/16，以及 IPv6的前缀 fc00:/7）被
保留用于构建专用网络。来自这些范围的地址可用于一个站点或组织内部的主机和路由器
之间的通信，但不能跨越全球性的Internet。因此，这些地址有时也被称为不可路由的地址。
也就是说，它们不能在公共-Internet 中路由。

专用、不可路由的地址空间管理完全由本地决定。IPv4 专用地址在家庭网络、中等规模

和大型企业内部网络中很常见。它们经常与网络地址转换（NAT）结合使用，在IP数据报进
入 Internet 时修改其中的IP 地址。我们在第7章详细讨论 NAT。

\subsection{IPv4/IPv6地址转换}
在有些网络中，可能需要在IPv4 和IPv6 之间转换\href{https://www.rfc-editor.org/rfc/rfc6127}{[RFC6127]}。目前，已制定了一个用

于单播转换的框架\href{https://www.rfc-editor.org/rfc/rfc6144}{[RFC6144]}，以及一个正在开发的用于组播转换的方案［IDV 4v6mc］。一
个基本功能是提供自动、基于算法的地址转换。例如，使用“知名的” IPv6 前缀 64:f9b:/96
或其他指定前缀，\href{https://www.rfc-editor.org/rfc/rfc6052}{[RFC6052]} 定义了如何在单播地址中实现它。

该方案使用一种特地址格式，称为嵌入IPv4 的IPv6地址。这种地址在IPv6地址肉

部包含IPv4地址。它可采用6种格式之一来编码，IPv6 前缀长度必须是下列数值之一：32、
40、48、56、64或96。图2-10显示了可用的格式。

，前缀长度

31

39

32

IPv6前缀

（32位）

47

IPv4地址

（32位）

63

71

79

87

95

U

103

后缀

（56位）

127

40

IPv6前缀

（40位）

IPv4地址

（前24位）

u

IPv4地址

（后8位）

后缀

（48位）

48

IPv6前缀

（48位）

IPv4地址

（前16位）

u

IPv4地址

（后16位）

后缀

（40位）

56

IPv6前缀

（56位）

IPv4地址

（前8位）

U

IPv4地址

（后24位）

后缀

（32位）

64

IPv6前缀

（64位）

U

IPv4地址

（32位）

后缀

（24位）

96

IPv6前缀

（96位）

IPv4地址

（32位）

图2-10

IPv4地址可以嵌人 IPv6地址中，形成一个嵌人IPv4 的IPv6地址。有6种不同的格式可用，

这取决于使用的IPv6前缀长度。众所周知的前缀 64:ff9b:/96 可用于IPv4 和 IPv6 单播地址之

间的自动转换

在该图中，前缀既可以是一个众所周知的前缀，也可以是组织为转换器分配的唯一前

缀。第64至71位必须设置为0，以保持与\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}指定标识符的兼容性。后缀的位被保
留，并且应设置为0。然后，采用简单方法来生成嵌人IPv4 的IPv6 地址：将IPv6 前缀与
32位的IPv4地址相串联，并确保第64至71位被设置为0（如果有必要，插人）。在后缀的
后面增加0，直到生成一个128地址。嵌人IPv4 的IPv6地址使用96位前缀选项，该选项
52

L53

通常用前面提到的IPv6 映射地址来表示（\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}中的2.2（3）节）。例如，嵌入IPv4 地址

198.51.100.16 和众所周知的前缀，生成地址 64:ff9b：：198.51.100.16。

\subsection{组播地址}
IPv4和IPv6支持组播寻址。一个IP 组播地址（也称组或组地址）标识一组主机接口，

而不是单个接口。一般来说，一个组可以跨越整个 Internet。一个组所覆盖的网络部分称

组的范围\href{https://www.rfc-editor.org/rfc/rfc2365}{[RFC2365]}。常见的范围包括节点本地（同一计算机）、链路本地（同一子网）、站点

本地（适用于一些站点）、全球（整个 Internet）和管理。管理范围的地址可用于一个网络区

域内已手动配置到路由器的地址。站点管理员可将路由器配置管理范围边界，这意味着相

关组的组播流量不会被路由器转发。注意，站点本地和管理范围只在使用组播寻址时有效。

在软件的控制下，每个 Internet 主机中的协议栈能加入或离开一个组播组。当一台主机

向一个组发送数据时，它会创建一个数据报，使用（单播）IP地址作为源地址，使用组播IP

地址作为目的地址。已加入组的所有主机将接收发送到该组的任何数据报。发送方通常不知

道主机是否接收到数据报，除非它们明确做出应答。事实上，发送方甚至不知道通常有多少

台主机接收它的数据报。

至此，原有的组播服务模型已成大家所知的任意源组播（ASM）。在这种模型下，任

何发送方可以发送给任何组；一个加入组的接收方被指定唯一的组地址。一种新方案称为源

特定组播（SSM）\href{https://www.rfc-editor.org/rfc/rfc3569}{[RFC3569]}\href{https://www.rfc-editor.org/rfc/rfc4607}{[RFC4607]}，在每个组中只使用一个发送方（见\href{https://www.rfc-editor.org/rfc/rfc4607}{[RFC4607]}的勘

误表）。在这种情况下，当一台主机加入一个组后，它会被指定一个信道地址，其中包括一

个组地址和一个源IP 地址。SSM 避免了ASM模型部署时的复杂性。尽管有多种组播形式在

整个 Internet 中广泛使用，但SSM 是当前更受欢迎的候选者。

在 Internet 社区中，对广域组播的理解和实现已经过十年以上的不懈努力，并且已经开

发出大量的广域组播协议。全球性 Internet 组播如何工作的细节超出本文的范围，有兴趣的

读者可以查看［IMR02］。第9章详细介绍本地IP组播如何工作。现在，我们要讨论IPv4 和

IPv6 组播地址的格式和意义。

\section{.3}
IPv4 组播地址

对于IPv4，D类空间（224.0.0.0 ~239.255.255.255）已被保留支持组播。28位空闲意

味着可提供228 =268 435 456个主机组（每个组是一个IP 地址）。这个地址空间被分为几个

主要部分，它建立在对路由分配和处理的基础上［IP4MA］。表2-9列出了这些主要部分。

表2-9

范围（包含）

224.0.0.0 ~ 224.0.0.255

224.0.1.0 ~ 224.0.1.255

224.0.2.0 ~ 224.0.255.255

224.1.0.0 ~ 224.1.255.255

224.2.0.0 ~ 224.2.255.255

224.3.0.0 ~ 224.4.255.255

224.5.0.0 ~ 224.255.255.255

225.0.0.0 ~ 231.255.255.255

用于支持组播的IPv4的D类地址空间的主要部分

特殊用途

本地网络控制；不转发

互联网络控制；正常转发

Ad hoc 块1

保留

SDP/SAP

Ad hoc 块2

保留

保留

参考文献

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc4566}{[RFC4566]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

［IP4MA］

［IP4MA］

Internet 地址结构

范围（包含）

232.0.0.0 ~ 232.255.255.255

233.0.0.0 ~ 233.251.255.255

233.252.0.0 ~ 233.255.255.255

234.0.0.0 ~ 234.255.255.255

235.0.0.0 ~ 238.255.255.255

239.0.0.0 ~ 239.255.255.255

特殊用途

源特定组播（SSM）

GLOP

Ad hoc 块3（233.252.0.0/24为文档保留）

基于单播前缀的IPv4 组播地址保留

管理范围

（续）

参考文献

\href{https://www.rfc-editor.org/rfc/rfc4607}{[RFC4607]}\href{https://www.rfc-editor.org/rfc/rfc4608}{[RFC4608]}

\href{https://www.rfc-editor.org/rfc/rfc3180}{[RFC3180]}

\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}

\href{https://www.rfc-editor.org/rfc/rfc6034}{[RFC6034]}

［IP4MA」

\href{https://www.rfc-editor.org/rfc/rfc2365}{[RFC2365]}

到224.255.255.255的地址块被分配给某些应用协议或组织使用。这些分配工作由IANA

或IETF完成。本地网络控制块限制为发送方的本地网络；发送到这些地址的数据报不会被

组播路由器转发。“所有主机”组（224.0.0.1）是这个块中的一个组。互联网络控制块类似

于本地网络控制范围，其目的是控制需要被路由到本地链路的流量。该地址块的一个例子是

网络时间协议（NTP）组播组（224.0.1.1）\href{https://www.rfc-editor.org/rfc/rfc5905}{[RFC5905]}。

第一个 Ad hoc（特定）块用于保留一些地址，避免它们落入本地或互联网络控制块。在

此范围内的大多数分配是用于商业服务，其中一些不（或永远不）需要全球地址分配；它们

可能最终被返还以支持GLOP®寻址（见下一段落）。在SDP/SAP块中包含某些应用所使用

的地址，例如会话目录工具（SDR）［H96］，它使用会话通告协议（SAP）发送组播会议通告

\href{https://www.rfc-editor.org/rfc/rfc2974}{[RFC2974]}。新的会话描述协议（SDP）\href{https://www.rfc-editor.org/rfc/rfc4566}{[RFC4566]} 最初只是SAP的一个组成部分，当前它

不仅用于IP 组播，而且与其他机制一起描述多媒体会话。

其他主要地址块的出现稍晚于IP 组播的演变。如前面所述，某些应用使用SSM块实

现SSM，结合自己的单播源地址形成一个SSM信道。在GLOP 块中，组播地址基于主机

的自治系统（AS）号，该主机处于应用分配地址的一端。AS 号用于ISP 之间的 Internet 范

围的路由协议，以聚合路由器和实现路由策略。AS号最初是16位，但现在已扩展到32位

\href{https://www.rfc-editor.org/rfc/rfc4893}{[RFC4893]}。GLOP 地址的生成是将一个16位AS号放在IPv4组播地址的第2和第3字节，

并且保留1字节的空间表示可能的组播地址（即多达256个地址）。因此，它可在一个16位

AS号和与这个 AS号相关联的GLOP组播地址之间来回映射。这个计算过程很简单，目前

已开发出几个在线计算器。®

最近，IPv4组播地址分配机制将多个组播地址与一个IPv4单播地址前缀关联。这

被称为基于单播前缀的组播寻址（UBM），它在\href{https://www.rfc-editor.org/rfc/rfc6034}{[RFC6034]}中描述。它基于 IPv6 发展早

期的一个类似结构，我们在前面2.5.4节讨论过。UBM的IPv4地址范围是234.0.0.0至

234.255.255.255。单播地址需分配一个/24或更短的前缀以使用UBM地址。分配更短的地

址（即/25或更长的前缀）必须使用一些其他机制。UBM地址被构造成前缀234/8、分配的

单播前缀和组播组 ID 的串联。图2-11 显示了这个格式。

为了确定与一个单播分配相关的UBM地址，分配前缀只是简单地在前面添加前缀

234/8。例如，单播IPv4地址前缀192.0.2.0/24有一个关联的UBM地址234.192.0.2。通过对

组播地址简单地“左平移”8位，有可能确定一个组播地址的所有者。例如，我们知道组播

地址范围234.128.32.0/24被分配给加州大学伯克利分校，这是由于相应的单播IPv4地址空

◎ GLOP 不是一个缩写，它只是一部分地址空间的名称。

例如、http://gigapop.uoregon.edu/glop/o

54

55

间 128.32.0.0/16（234.128.32.0 的“左移”版本）是由加州大学伯克利分校所拥有（可以使用
WHOIS 查询来确定，见2.6.1.1节）。

78

31

234

（8位）

单播前缀

组ID

（最多24位）

（最多16位）

图 2-11

IPV4 的UBM地址格式。为单播地址分配/24或更短的前缀，关联的组播地址分配基于前缀

234/8、分配的单播前缀和组播组ID 的串联。因此，较短的单播前缀分配包含更多单播和组

播地址

UBM地址比其他类型的组播地址分配有更多优点。例如，用于GLOP 寻址时，它们可

以不受16位AS号限制。另外，它们可作为已存在的单播地址空间的分配结果。因此，使
用组播地址的站点知道哪些地址可用，并且不需要进一步协调。最后，UBM地址可以比
GLOP 地址更好地分配，对应的AS号可分配到更细粒度。在今天的Internet 中，一个AS号
可以与多个站点关联，但令人沮丧的是UBM 支持在地址和所有者之间的简单映射。

管理范围的地址块可用于限制分布在路由器和主机的特定集合中的组播流量。它可以看

作组播对专用单播IP地址的模拟。这种地址不能用于将组播分发到 Internet，这是因为其中
大多数流量被阻塞在企业边界。大型站点有时会划分管理范围的组播地址，以用于某些特定
范围（例如，工作组、部门和地理区域）。

\section{.4}
IPv6组播地址

对于 IPv6，对组播的使用相当积极，前缀 ff00:/8已被预留给组播地址，并且112位可

用于保存组号，可提供的组数为2 22=5 192 296 858 534 827 628 530 496 329220 096。其一
般格式如图 2-12所示。

16

1111111

！P

组ID（112位）

图2-12

标志

范围

（4位）（4位）

基本的 IPv6 组播地址格式包括4个标志位（0，保留；R，包含会合点；P，使用单播前缀；T，

是临时的）。4位范围值表示组播的范围（全球、本地等）。组ID编码在低序的112位中。如

果P或R位被设置，则使用一种代替格式

IPv6组播地址的第2字节包含一个4位标志字段和一个4位范围ID字段。范围字段表

示到某些组播地址的数据报的分配限制。十六进制值0、3和f保留。十六进制值6、7和
9~d未分配。表2-10给出了这些值（根据\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}中的2.7节）。

值

范围

表2-10

IPv6 范围字段的值

值

范围

0

3

保留

接口/ 机器本地

链路/ 子网本地

保留

4

5

6

8

～

7

管理

站点本地

未分配

组织本地

值

9~d

e

f

范围

未分配

全球

保留

Internet 地址结构

很多IPv6组播地址由IANA分配为永久使用，并且故意跨越多个地址范围。这些组播

地址对每个范围都有一定偏移量（由于这个原因，这些地址被称为相对范围或可变范围）。例
如，可变范围的组播地址 ffOx：：101 是由［IP6MA］为NTP服务器预留。x 表示可变范围，表
2-11显示了一些预留定义的地址。

表 2-11

针对 NTP（101）的永久可变范围的IPV6 组播地址保留的例子

地址

ff01：：101

ffO2：：101

ff04：：101

ff05：：101

ff08：：101

ffOe：：101

含义

同一机器中的所有 NTP服务器

同一链路/子网中的所有 NTP服务器

某些管理定义范围内的所有NTP 服务器

同一站点中的所有NTP服务器

同一组织中的所有NTP 服务器

Internet 中的所有 NTP 服务器

在IPv6中，当P和R位字段设置0时，使用图2-12中给出的组播地址格式。当

P设置1，无须基于每个组的全球性许可，对组播地址有两个可选方法。它们被描述在
\href{https://www.rfc-editor.org/rfc/rfc3306}{[RFC3306]}和\href{https://www.rfc-editor.org/rfc/rfc4489}{[RFC4489]}中。第一种方法称为基于单播前缀的IPv6 组播地址分配，由ISP或
地址分配机构提供单播前缀分配，并且有效分配一个组播地址集合，从而限制了因避免重复
而需全球协调的数量。第二种方法称为链路范围的IPv6组播，使用接口标识符，并且组播
地址是基于主机的IID。为了了解这些不同格式如何工作，首先要了解IPv6 组播地址中位字
段的使用细节。它们被定义在表2-12中。

位字段（标志）

R

P

T

表2-12 IPv6 组播地址标志

含义

会合点标志（0，常规的；1，包括RP地址）

前缀标志（0，常规的；1，基于单播前缀的地址）

临时标志（0，永久分配的；1，临时的）

参考文献

\href{https://www.rfc-editor.org/rfc/rfc3956}{[RFC3956]}

\href{https://www.rfc-editor.org/rfc/rfc3300}{[RFC3300]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

当T位字段被设置时，表示组地址是临时或动态分配的；它不是［IP6MA］ 中定义的标

准地址。当P位字段被设置为1，T位也必须被设置为1。当这种情况发生时，使用基于单
播地址前缀的特殊格式的 IPv6 组播地址，如图2-13所示。

0

16

11111111

0011

00000000

SSM设为0

（SSM设为0）

标志

范围

保留

前缀长度

前缀

组ID

（4位）（4位）

（8位）

（8位）

（64位）

（32位）

图 2-13

IPv6 组播地址可以基于单播IPv6地址来创建\href{https://www.rfc-editor.org/rfc/rfc3306}{[RFC3306]}。在这样做时，P位字段设置为1，

单播前缀和32位的组ID 被加入地址。这种形式的组播地址分配简少了全球地址分配协议的

需求

这里，我们可以看到如何使用基于单播前缀的地址改变组播地址格式，包括一个单播前

缀及其长度，以及一个更小的（32位）组ID。该方案的目的是提供全球唯一的IPv6 组播地
址分配方式，同时不需要提出新的全球性机制。由于IPv6单播地址已分配全球性的前缀单
元（见2.6节），所以在组播地址中可以使用这个前缀中的位，从而在组播应用中利用现有的
单播地址分配方法。例如，一个组织分配了一个单播前缀 3ffe:ffff:1：：/48，那么它随之分配了
一个基于单播的组播前缀 ff3x:30:3ffe:ffff:1：：/96，其中x是任何有效范围。SSM通过设置前
缀长度和将前缀字段设置为0来支持这种格式，以便有效地将前缀ff3x:/32（其中x 是任何
有效的范围值）用于所有这类IPv6 SSM 组播地址。

为了创建唯一的链路本地范围的组播地址，可使用一种基于IID 的方法\href{https://www.rfc-editor.org/rfc/rfc4489}{[RFC4489]}，当

只需要链路本地范围时，这种方法是基于单播前缀分配的首选。在这种情况下，可使用另一
种形式的IPv6组播地址结构（见图2-14）。

16

11111111

010：

＜=2

00000000

11111111

标志

范围

保留

前缀长度

TID

组ID

（4位）（4位）

（8位）

（8位）

（64位）

（32位）

图2-14

IPv6 链路范围的组播地址格式。只适用于链路（或更小）范围内的地址，组播地址可以结合

IPv6 接口 ID 和组ID 来形成。这种映射是直接的，所有地址使用前缀形式ff3:0011/32，其中

x是范围ID并且小于3

图2-14所示的地址格式与图2-13的格式相似，除了前缀长度字段被设置为255，并将

随后字段中的前缀替换为IPv6的IID。这个结构的优点是不需要提供前缀以形成组播地址。
在不需要路由器的Ad hoc（无线自组织）网络中，一台单独的计算机可基于自己的IID 形成
唯一的组播地址，而无须运行一个复杂的许可协议。如前所述，这种格式只适用于本地链路
或节点组播范围。但是，当需要更大的范围时，无论是基于单播前缀的地址还是永久组播地
址都可使用。作为这种格式的一个例子，一个ID 为02-11-22-33-44-55-66-77的主机将使用
组播地址ff3x：0011:0211:2233:4455:6677:ggg8:gg8g，其中x是一个等于或小于2的范围值，
gggg:gggg 是一个 32位组播组 ID 的十六进制表示。

我们还要讨论的位字段是R位字段。当使用基于单播前缀的地址（P位被设置）时，它

表示组播路由协议需要知道一个会合点。

注意 会合点（RP）是一个路由器中用于处理一个或多个组播组的组播路由的IP

地址。RP用于 PIM-SM 协议\href{https://www.rfc-editor.org/rfc/rfc4601}{[RFC4601]}，以帮助参加同一组播组中的发送方和接

收方找到对方。Internet 范围的组播部署遇到的问题之一是会合点定位。这种方法

重载IPV6组播地址以包含一个RP地址。因此，从一个组地址找到一个RP是简单

的，只需从中选择合适的位的子集。

当标志P被设置时，图2-15显示了组播地址修改后的格式。

图2-15所示的格式与图2-13类似，但不使用SSM（这样前缀长度不能为零）。另外，

新引入了一个称为RIID 的4位字段。为了形成图2-15所示格式的基于 RP地址的IPv6地
址，前缀长度字段表示的位数从前缀字段提取，并放置在一个新的IPv6地址的高位。然后，
RIID 字段值被用作 RP地址的低4位。剩余的部分用零填充。作为一个例子，我们看一个组
播地址 ff75:940:2001:db8:dead:beef:f00d:face。在这个例子中，范围为5（站点本地），RIID
字段值为9，前缀长度0x40=64位。因此，前缀本身为2001:db8:dead:beef， RP地址力
2001:db8:dead:beef：：9. 更多的例子见「RFC39561.


图2-15 RP的单播 IPv6地址可嵌人IPv6组播地址\href{https://www.rfc-editor.org/rfc/rfc3956}{[RFC3956]}。这样，它可以直接找到用于路由的
RP关联的地址。RP被用于组播路由系统，以协调不在同一子网中的组播发送方和接收方

与IPv4相似，IPv6 也有一些保留的组播地址。除了前面提到的可变范围地址，这些地

址还根据范围划分成组。表2-13给出了一个 IPv6 组播空间中的保留列表。［IP6MA］提供了
更多的信息。

地

址

ffO1：：1

ff01：：2

ffOl：：fb

ff02：：1

ff02：：2

ff02：：4

ff02：：5

ff02：：6

ff02：：9

ff02：：a

ff02：：d

ff02：：16

ff02：：6a

ff02：：6d

f02:f

ff02：：1:2

f02：：1:3

ff02：：1:ffxx:xxx×

f05：：2

f05：：fb

f05：：1:3

ffOx：：

ffOx：：fb

ff0x:101

ff0x:133

ffOx:18c

ff3x：：/32

表2-13

围

IPv6 组播地址空间中的保留地址

特殊用途

范

节点

节点

节点

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

链路

站点

站点

站点

可变的

可变的

可变的

可变的

可变的

（特殊的）

任播地址

所有节点

所有路由器

mDNSv6

所有节点

所有路由器

DVMRP 路由器

OSPFIGP

基于 OSPFIGP设计的路由器

RIPng路由器

EIGRP 路由器

PIM 路由器

支持 MLDv2的路由器

所有探测器

LL-MANET 路由器

mDNSv6

所有 DHCP 代理

LLMNR

请求节点地址范围

所有路由器

mDNSv6

所有 DHCP 服务器

保留

mDNSv6

NTP

聚合服务器访问协议

所有 AC 的地址（CAPWAP）

SSM 块

参考文献

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

［IDChes］

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc1075}{[RFC1075]}

\href{https://www.rfc-editor.org/rfc/rfc2328}{[RFC2328]}

\href{https://www.rfc-editor.org/rfc/rfc2328}{[RFC2328]}

\href{https://www.rfc-editor.org/rfc/rfc2080}{[RFC2080]}

［EIGRP］

\href{https://www.rfc-editor.org/rfc/rfc5059}{[RFC5059]}

\href{https://www.rfc-editor.org/rfc/rfc3810}{[RFC3810]}

\href{https://www.rfc-editor.org/rfc/rfc4286}{[RFC4286]}

\href{https://www.rfc-editor.org/rfc/rfc5498}{[RFC5498]}

［IDChes］

\href{https://www.rfc-editor.org/rfc/rfc3315}{[RFC3315]}

\href{https://www.rfc-editor.org/rfc/rfc4795}{[RFC4795]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

［IDChes］

\href{https://www.rfc-editor.org/rfc/rfc3315}{[RFC3315]}

\href{https://www.rfc-editor.org/rfc/rfc4291}{[RFC4291]}

［IDChes］

\href{https://www.rfc-editor.org/rfc/rfc5905}{[RFC5905]}

\href{https://www.rfc-editor.org/rfc/rfc5352}{[RFC5352]}

\href{https://www.rfc-editor.org/rfc/rfc5415}{[RFC5415]}

\href{https://www.rfc-editor.org/rfc/rfc4607}{[RFC4607]}

任播地址是一个单播IPv4或IPv6地址，这些地址根据它所在的网络确定不同的主机。

这是通过配置路由器通知 Internet 中多个站点有相同单播路由来实现。因此，一个任播地址
不是指Internet 中的一台主机，而是对于任播地址“最合适”或“最接近”的一台主机。任
播地址最常用于发现一台提供了常用服务的计算机\href{https://www.rfc-editor.org/rfc/rfc4786}{[RFC4786]}。例如，某个数据报发送到一
个任播地址，可用于找到 DNS服务器（见第11章），6to4 网关将 IPv6流量封装在IPv4 隧道
中\href{https://www.rfc-editor.org/rfc/rfc3068}{[RFC3068]}，或用于组播路由的 RP 中\href{https://www.rfc-editor.org/rfc/rfc4610}{[RFC4610]}。

\section{分配}
IP 地址空间通常被分配为大的块，这由一些分层次组织的权威机构完成。权威机构是为

各种“所有者”分配地址空间的组织，“所有者”通常是ISP 或其他较小的权威机构。权威
机构经常参与全球单播地址空间分配，但有时也分配其他类型的地址（组播和特殊用途）。权
威机构为用户分配一个不限时的地址块，或是一个限时（例如实验）的地址块。这个层次结
构的顶部是IANA［IANA］，它负责分配 IP 地址和 Internet 协议使用的其他号码。

\subsection{单播}
对于单播IPv4 和IPv6的地址空间，IANA 将分配权限主要委托给几个地区性 Internet

注册机构（RIR）。RIR 之间通过一个组织互相协作，即2003年创建的号码资源组织（NRO）
［NRO］。表2-14给出了本书写作时（2011年中期）的一组RIR，它们都加人了 NRO。截至
2011年初，IANA 拥有的剩余的IPv4单播地址空间将移交给这些 RIR 分配。

表2-14 加入 NRO 的地区性 Internet 注册机构

负责的地区

RIR 名称

AfriNIC

一非洲网络信息中心

APNIC-

一亚州太平洋地区网络信息中心

ARIN

美洲 Internet 号码注册机构

LACNIC—拉丁美洲和加勒比地区的IP地址注册

RIPE NCC

欧洲网络协调中心

非洲

亚洲/太平洋地区

北美洲

拉丁美洲和一些加勒比岛屿

欧洲、中东、中亚

参考文献

http://www.afrinic.net

http://www.apnic.net

http://www.arin.net

http://lacnic.net/en/index.html

http://www.ripe.net

这些实体通常处理较大的地址块［IP4AS］［IP6AS］。他们为一些国家（例如澳大利亚和新

加坡）运营的小型注册机构和大型ISP分配地址空间。接下来，ISP 为自己和自己的客户提
供地址空间。当用户登记 Internet 服务时，他们通常以地址前缀形式使用ISP地址空间的一
部分（通常很小）。这些地址范围由客户的ISP拥有和管理，并被称为供应商聚合（PA）的地
址，这是由于它们包含一个或多个前缀，并可与ISP的其他前缀实现聚合。这种地址有时也
称为不可移植的地址。交换供应商通常需要客户自己修改连接到 Internet 的所有主机和路由
器的IP 前缀（这种不愉快的操作通常称为重新编号）。

一种可选的地址空间类型称为供应商独立（PI）的地址空间。从PI 空间分配的地址可以

直接分配给用户，并且可以由任何ISP来使用。但是，由于这些地址是客户拥有的，它们没
有与ISP 的地址在数字上相邻，因此它们不能聚合。一个ISP 需要为客户的PI 地址提供路
由，客户可能需要为路由服务支付额外费用，或根本不支持这种服务。在某种意义上，一个
ISP 同意客户的PI 地址提供路由，相对于其他客户有一个额外成本，它会增加自己的路由
表大小。另一方面，很多站点喜欢使用PI 地址，他们可能愿意支付额外费用，因有助

转换ISP 时避免重新编号（这被称为供应商锁）。

Internet 地址结构

43

\subsubsection{例子}
这时，可能需要使用 Internet 中的WHOIS服务，以确定如何分配地址空间。例如，我

们可通过访问相应的 URL http://whois.arin.net/rest/ip/72.1.140.203.txt，形成一个对IPv4地址
72.1.140.203的信息查询：

NetRange：

72.1.140.192 - 72.1.140.223

CIDR：

72.1.140.192/27

OriginAs：

NetName：

NetHandle：

Parent：

NetType：

RegDate：

Updated：

Ref：

SPEK-SEA5-PART-1

NET-72-1-140-192-1

NET-72-1-128-0-1

Reassigned

2005-06-29

2005-06-29

http://whois.arin.net/rest/net/NET-72-1-140-192-1

这里，我们看到地址 72.1.140.203实际上是网络SPEK-SEAS-PART-1 的一部分，并且

已分配地址范围72.1.140.192/27。另外，我们可以看到，SPEK-SEAS-PART-1 的地址范围是
NET-72-1-128-0-1 的PA地址空间的一部分。我们可生成一个关于该网络的信息查询，需要
访问 URL http://whois.arin.net/rest/net/NET-72-1-128-0-1.txt。

NetRange：

72.1.128.0 - 72.1.191.255

CIDR：

72.1.128.0/18

OriginAS：

NetName：

NetHandle：

Parent：

NetType：

RegDate：

Updated：

Ref：

SPEAKEASY-6

NET-72-1-128-0-1

NET-72-0-0-0-0

Direct Allocation

2004-09-09

2009-05-19

http://whois.arin.net/rest/net/NET-72-1-128-0-1

这个记录指出地址范围 72.1.128.0/18（称 “句柄”或名称 NET-72-1-128-0-1）已被直

接分配，它在 ARIN 管理的地址范围 72.0.0.0/8之外。有关 ARIN 支持的数据格式和多种方
法的更多细节，可以通过WHOIS 查询在［WRWS］中看到。

通过其他Interet 注册机构，我们可以看到不同的结果。例如，如果使用Web 查询接口

http://www.ripe.net/whois 搜索有关IPv4 地址193.5.93.80的信息，我们将获得下面的结果：

8 This is the RIPE Database query service.

8 The objects are in RPSL format.

8 The RIPE Database is subject to Terms and Conditions.

暑

See http://www.ripe.net/db/support/db-terms-conditions•pdf

名

8 Note: This output has been filtered.

To receive

output

for

a database update,use the "-B" flag•

8 Information related to '193.5.88.0 - 193.5.95.255'

inetnum：

193.5.88.0 - 193.5.95.255

netname：

WIPONEI

descr：

World Intellectual Property Organization

descr：

UN Specialized

Agency

descr：

Geneva

country：

CH

admin-c：

AM4504-RIPE

tech-c：

AM4504-RIPE

status：

ASSIGNED PI

mnt-by：

CH-UNISOURCE-MNT

mnt-by：

DE-COLT-MNT

sourCe：

RIPE

我们可以看到，地址193.5.93.80是分配给 WIPO 的地址块 193.5.88.0/21 的一部分。注

意，这个块的状态为ASSIGNED PI，意味着该地址块是供应商独立类型。RPSL 的参考文献
表示数据库记录使用路由策略规范语言 \href{https://www.rfc-editor.org/rfc/rfc2622}{[RFC2622]}\href{https://www.rfc-editor.org/rfc/rfc4012}{[RFC4012]}，ISP 用它来表示自己的路由策
略。这些信息允许网络运营商配置路由器，以帮助缓解 Internet 中的路由不稳定。

\subsection{组播}
在IPv4 和IPv6中，组播地址（即组地址）可根据其范围来描述，它们需要确定组播方

式（静态、动态的协议或算法），以及是否使用ASM或SSM。这些组的分配策略已被制定
（\href{https://www.rfc-editor.org/rfc/rfc5771}{[RFC5771]}针对IPv4；\href{https://www.rfc-editor.org/rfc/rfc3307}{[RFC3307]}针对IPv6），整体架构在\href{https://www.rfc-editor.org/rfc/rfc6308}{[RFC6308]}中详细描述。全球
范围之外的组（例如管理范围的地址和IPv6链路范围的组播地址）可在 Internet 的各个部分
重复使用，并由网络管理员配置管理范围之外的地址块或由端主机自动选择。静态分配的全
球范围地址通常是固定的，并且可能被硬件编码到应用中。这种地址空间是有限的，特别是
在IPv4中，这种地址实际上计划被用于任何其他 Internet 站点。通过算法确定的全球范围
地址可以像 GLOP 基于AS号创建，或是根据相关的单播前缀分配。注意，SSM 可使用全
球范围的地址（即来自SSM块）、管理范围的地址，或前缀实际为0的基于单播前缀的IPv6
地址。

我们可以看到，大量的协议和复杂的组播地址格式，导致组播地址管理成为一个难题

（更不用说全球组播路由\href{https://www.rfc-editor.org/rfc/rfc5110}{[RFC5110]}）。从用户的角度来看，组播很少使用，可能受到的关注
有限。从程序员的角度来看，在应用设计中支持组播可能是有价值的，\href{https://www.rfc-editor.org/rfc/rfc3170}{[RFC3170]} 提供了一
些这方面的设想。当网络管理员需要实现组播时，与服务提供商的交流可能是必要的。另
外，一些组播地址分配方案已由厂商开发［CGEMA］。

\section{单播地址分配}
一个站点分配了单播IP地址范围后—通常是从自己的ISP处获得，站点或网络管理

员需要决定如何为每个网络接口指定地址，以及如何建立子网结构。如果这个站点只有一个
物理网段（例如大多数家庭），这个过程相对简单。对于规模较大的企业，尤其是那些由多
个ISP提供服务，并且多个物理网段分布在很大地理区域的企业，这个过程可能非常复杂。
我们来看在以下情况下如何工作，家庭用户使用一个专用地址和一个 ISP 提供的IPv4 地址。
这是目前常见的场景。接着，我们继续介绍一些更复杂的情况。

\subsection{单个供应商/无网络/单个地址}
目前，我们可获得的最简单的 Internet服务是由ISP 提供一个在一台计算机上使用的IP

地址（在美国通常只是IPv4）。例如，对于 DSL 服务，单个地址可被分配到一个点到点链路
的一端，并可能只是暂时的。例如，如果用户的计算机通过DSL 连接 Internet，它可能在某
天被分配了一个地址 63.204.134.177。在计算机上运行的任何程序可以发送和接收 Internet
流量，这些流量将采用63.204.134.177作为IPv4源地址。一台主机同样也有其他活动的IP
地址。这些地址包括本地的“回送”地址（127.0.0.1）和一些组播地址，至少包括所有主机
的组播地址（224.0.0.1）。如果主机正在运行IPv6，它至少使用所有节点的IPv6组播地址
Internet 地址结构

45

（ff02：：1）、ISP 分配的任何IPv6地址、IPv6 回送地址（：：1）和为每个网络接口配置的一个用
于IPv6的链接本地地址。

为了在 Linux 上查看一台主机使用的组播地址（组），我们可使用 ifconfg 和 netstat 命令

查看正在使用的IP 地址和组：

\begin{verbatim}
    
Linux& ifconfig pppo

PPPO

Link encap:Point-to-Point Protocol

inet addr:71.141.244.213

P-t-P:71.141.255.254 Mask:255.255.255.255

UP POINTOPOINT RUNNING NOARP MULTICAST MTU:1492 Metric:1

RX

Packets:33134 errors:0 dropped: 0 overruns:0 frame:0

TX

Packets:41031 errors:0 dropped:0 overruns:0 carrier:0

collisions:0 txqueuelen:3

RX bytes:17748984 （16.9 MiB） ™X bytes:9272209 （8.8 MiB）

Linux&

netstat

-9n

IPv6/IPV4 Group Memberships

Interface

RefCnt Group

10

PPPO

PPPO

10

1

1

224.0.0.1

224.0.0.251

224.0.0.1

££02：：1
\end{verbatim}

这里，我们看到设备pppO关联的一条点到点链路，它已分配 IPv4 地址 71.141.244.213；

但没有分配IPv6地址。这台主机系统已启用IPv6，但当检查它的组成员时，我们看到其
本地回送（1o）接口出现在“所有IPv6 节点” 组播组中。我们也可以看到，IPv4所有节点
组正在使用，以及 mDNS（组播 DNS）服务［IDChes］。mDNS 协议使用静态IPv4 组播地址
224.0.0.251。

\subsection{单个供应商/ 单个网络/单个地址}
很多拥有多台计算机的Internet 用户发现，只有一台计算机连接到 Internet 并不是理想

情况。因此，他们通常拥有家庭局域网（LAN）或无线局域网（WLAN），并使用一台路由
器或主机作为路由器连接Internet。这种配置与单个计算机的情况相似，除了路由器将分组
从家庭网络转发到ISP，它们也执行 NAT（见第7章；在 Windows 中称为 Internet 连接共享
（ICS）），在与ISP通信时重写分组中的IP 地址。从ISP的角度来看，只有一个IP 地址被使
用。目前，这些操作大部分是自动的，因此需要手动配置的地址很少。路由器使用DHCP为
家庭用户提供自动地址分配。如果有必要，它们也为与ISP建立链路提供地址分配。第6章
详细介绍 DHCP 操作和主机配置。

\section{.3}
单个供应商/多个网络/多个地址

很多组织发现仅分配一个单播地址，特别是当它只是暂时分配时，通常无法满足自己的

上网需求。对于运行 Internet服务器（例如web 站点）的组织，通常希望拥有一个固定的IP
地址。这些站点经常有多个局域网，其中有些是内部的（通过防火墙和 NAT设备与 Internet
分离），有些可能是外部网（为 Internet 提供服务）。对于这样的网络，通常需要有一个站点
或网络管理员，以确定站点需要多少个IP地址，如何构建网站的子网，以及哪些子网是内
部或外部网。图2-16显示了典型的中小规模企业方案。

67

68

Internet

137.164.23.30/32

前往或来自128.32.2.｛64～127｝

（128.32.2.64/26）的所有流量

“DMZ"

企业边界

路由器

128.32.2.65/26

128.32.2.70/26

128.32.2.66/26

内部NAT

路由器

10.0.0.1/16

10.0.｛0~255｝.40~255｝

10.0.0.123

（10.0.0.0/16）

图2-16一个典型的小型到中型规模的企业网络。该网站已被分配 128.32.2.64/26 范围肉的64个公开

（可路由）的IPv4 地址。“DMZ”网络包含 Internet 中可见的服务器。内部路由器使用 NAT为

企业内部的计算机提供 Internet 访问

在该图中，一个站点已分配前缀 128.32.2.64/26，提供最多64（减2）个可路由的IPv4

地址。“DMZ”网络（“非军事区”网络，在主防火墻之外，见第7章）用来连接服务器，

以便 Internet 中的用户可以访问它们。这种计算机通常提供Web 访问、登录服务器和其他

服务。这些服务器的IP 地址来自前缀范围的一小部分；很多站点只拥有少数的公共服务器。

站点前缀中的保留地址交给 NAT 路由器，将它们作为一个“NAT池”（见第7章）的基础。

NAT 路由器可以使用池中的任何地址重写进入或离开内部网络的数据报。图2-16显示的网

络设置很方便，这里主要有两个原因。

首先，将内部网络与 DMZ分隔开，有助于保护内部的计算机免受破坏，并由 DMZ服

务器来面对攻击。另外，它会设置区域内的IP地址。在边界路由器、DMZ和内部 NAT路由

器建立后，可在内部使用任何地址结构，其中可以使用很多（专用的）IP地址。当然，这个

例子只是建立小型的企业网络的一种方式，其他因素（例如成本）可能最终决定路由器、网

络和IP地址在小型或中型规模的企业中的部署方式。

\subsection{多个供应商/ 多个网络/ 多个地址（多宿主）}
对于一些依赖 Internet 接人来保证持续运营的组织，他们通常使用一个以上的供应商

（称为多宿主），以便在失效时或其他情况下提供冗余连接。由于 CIDR，只有一个 ISP 的组织

通常拥有与该ISP相关联的PA地址。如果他们又使用一个ISP，这样会出现每个主机使用

哪个IP地址的问题。目前，已有针对多个ISP 同时运行的方法，以及在ISP之间转换的指

导原则（其中提出了一些类似问题）。对于 IPv4，\href{https://www.rfc-editor.org/rfc/rfc4116}{[RFC4116]}讨论了 PI或PA地址如何用

多宿主。我们看图2-17所示的情况。

Internet 地址结构

47

互联网其他部分

B

ISP P1

（12/8）

ISP P2

（137.164/16

PA:12.46.129.0/25

站点S

Pl: 198.134.135.0/24

图2-17 供应商聚合和供应商独立的IPv4地址用于一个假设的多宿主企业。如果PI 地址是可用的，
站点运营者倾向于选择使用PI空间。ISP 更喜欢PA 空间，因为它可促进前缀聚合，减少路

由表的大小

这里，一个虚拟的站点S有两个ISP，即P1和P2。如果它使用来自PI块（12.46.129.0/25）

的PA地址空间，将在C和D点把该前缀分别通知PI 和P2。这个前缀可被P1聚合到自己
的12/8块，并在A点将它通知 Internet 其他部分，但P2 不能在B点聚合该前缀，因为它与自
己的前缀（137.164/16）在数值上不相邻。另外，从 Internet 其他部分的一些主机的角度来看，
12.46.129.0/25的流量趋向于ISP P2而不是ISP P1，因为站点S的前缀比它通过P1时更长
（“更具体”）。这是Internet 路由（详情见第5章）采用最长匹配前缀算法工作方式的结果。
本质上，一台Internet 其他部分的主机经过A点匹配的前缀12.0.0.0/8或B点匹配的前缀
12.46.129.0/25都可到达12.46.129.1。由于每个前缀都匹配（即目的地址12.46.129.1 中包含
一组共同的前缀位），则具有更大或更长的那个前缀是首选，在这种情况下是P2。因此，P2
位于无法聚合来自S的前缀的位置，并需要携带更多站点S的流量。

如果站点S决定使用PI空间而不是PA空间，这个情况更对称。但是，不聚合是可能

的。在这种情况下，它在C和D点将PI 前缀198.134.135.0/24分别通知P1和P2，但任何
ISP 都不能聚合它，因为它与ISP 地址块中任何一个数值都不相邻。因此，每个ISP在A点
和B点通知可识别的前缀 198.134.135.0/24。在这种方式下，在Internet 路由中执行“自然
的”最短路径计算，站点S可通过更靠近发送主机的ISP 到达。另外，如果站点S决定切换
另一个 ISP，它不需要改变其分配的地址。不幸的是，无法聚合这种地址可能关系到 Internet
未来的扩展性，因此PI 空间相对供不应求。

IPv6多宿主已成为IETF 近年来的研究课题，并出现了Multi6 体系结构\href{https://www.rfc-editor.org/rfc/rfc4177}{[RFC4177]}

和Shim6 协议 \href{https://www.rfc-editor.org/rfc/rfc5533}{[RFC5533]}。Multi6 概括了一些已提出处理意见的方法。从广义上来说，上
述选择包括使用一种相当于前面提到的IPv4多宿主的路由方式、使用移动IPv6的能力
\href{https://www.rfc-editor.org/rfc/rfc6275}{[RFC6275]}，以及采用一种将节点标识符与定位符分离的新方法。当前，IP地址作为连接
Internet 的一个网络接口标识符（本质上是一种名称）和定位符（一种路由系统理解的地址）。
这种分离使得将来即使在底层IP地址改变的情况下网络协议也能够实现。提供这种分离白
协议有时称为标识符/定位符分离或id/loc 分离协议。

Shim6 介绍了一个网络层协议“隔离层”（shim），传输层协议使用它分离来自 IP地址的
“上层协议标识符”。多宿主通过选择使用的 IP 地址（定位符）来实现，基于动态网络环境且
不需要PI地址分配。通信主机（端点）之间对使用的定位符及交换的时机进行协商。标识符
与定位符分离是其他几项工作的主题，包括实验性的主机标识协议（HIP）\href{https://www.rfc-editor.org/rfc/rfc4423}{[RFC4423]}，它使
用加密的主机标识符来标识主机。这种标识符实际上是与主机相关的公共/私人密钥对中的
公钥，因此来源于一个特定主机的HIP 流量可被认证。第18 章将详细讨论安全问题。

\section{与IP 地址相关的攻击}

IP 地址基本上都是数字，只有少数网络攻击涉及它们。一般情况下，执行攻击可发送
“欺骗”数据包（见第5章）或其他相关活动。也就是说，IP地址现在有助于查明涉嫌不良
活动的个体（例如，对等网络中的版权侵权或非法材料分发）。这样做可能被以下几个原因所
误导。例如，在很多情况下，IP 地址只是暂时的，并在不同时间重新分配给不同用户。因此，
在精确计时中出现任何错误，容易造成数据库中的IP地址到用户的映射出错。另外，访问
控制没有被广泛和安全地部署；用户可能通过一些公共的接人点，或一些无意中开放的家庭
或办公室的无线路由器连接Internet。在这种情况下，不知情的家庭或企业所有者可能因IP
地址而成为嫌疑人，即使这个人并不是网络流量的发送者。这种情况也可能因受攻击的主机
被用于组成僵尸网络而发生。目前，这类计算机（和路由器）可通过基于 Internet 的黑市来
租赁，并被用于执行攻击、非法内容服务和其他违法活动\href{https://www.rfc-editor.org/rfc/rfc4948}{[RFC4948]}。

\section{总结}

IP 地址用于识别和定位整个 Internet 系统（单播地址）中设备的网络接口。它也用于识
别多个接口（组播、广播或任播地址）。每个接口有一个最少32位的IPv4地址，并且通常有
几个128位的IPv6地址。单播地址由一些分层次组织的管理机构分配成块。由这些机构分
配的前缀表示一个单播IP 地址空间块，这些块通常分配给ISP，并由它们为自己的用户分配
地址。这种前缀通常是ISP地址块的子区间（称为供应商聚合的地址或PA地址），但也可能
代之为用户拥有的地址（称为供应商独立的地址或PI地址）。数值相邻的地址前缀（PA 地址）
可被聚合，以节省路由表空间和提高 Internet 扩展性。这种方法出现于由A、B、C类网络号
组成的“有类别”Internet 网络结构被无类别域间路由（CIDR）所取代时。CIDR允许根据对
地址空间的不同需求，将不同大小的地址块分配给某个组织，CIDR实际上可以更有效地分
配地址空间。任播地址是根据发送者位置指向不同主机的单播地址；这种地址常用于发现可
能出现在不同位置的网络服务。

IPv6单播地址与IPv4地址有所不同。最重要的是，IPv6地址有一个范围的概念，无论是
单播地址还是组播地址，都需要明确指出地址的有效范围。典型的范围包括节点本地、链路
本地和全球范围。链路本地地址通常基于一个标准前缀和一个ID 创建，这个ID 可由低层协
议（例如硬件/MAC地址）基于地址提供或取随机值。这种方法有助于自动配置IPv6地址。

IPv4 和IPv6都支持同时指向多个网络接口的地址格式。IPv4 支持广播地址和组播地址，
但IPv6只支持组播地址。广播允许一人对所有人通信，而组播允许一人对多人通信。发送
方向组播组（IP地址）的发送，其行为有点像电视频道；发送方并不知道接收方信息或一个
信道中有多少个接收方。Internet 中的全球性组播已发展了十多年，并且涉及很多协议，有
些是针对路由，有些是针对地址分配和协调，有些是针对主机希望加入或离开一个组的信
息。无论是 IPv4 还是IPv6，特别是IPv6，都有很多类型和用途的组播地址。IPv6组播地址
格式变化提供了基于单播前缀分配组的方法，在组中嵌入路由信息（RP地址），并且能基于
IID 创建组播地址。

可以说CIDR 的开发和部署是 Internet核心路由系统的一个根本性变化。CIDR 成功地
为分配地址空间提供更多灵活性，并通过聚合提升路由的可扩展性。另外，IPv6 在20世纪
90年代初开始受到更多重视，这是出于很快将会需要更多地址的想法。当时没有预见的是，
NAT（见第7章）的广泛使用显著推迟了IPv6的使用，这是因为连接 Internet 的每台主机不
再需要唯一的地址。相反，大型网络使用专用地址空间已司空见惯。但是，可用于路由的IP
地址数量最终将减少到零，因此未来将会出现一些变化。2011年2月，IANA分配了最后5
个18的IPv4地址前缀，5个 RIR 各分配1个前缀。2011年04月15日，APNIC用尽了其所
有可分配的前缀。剩余前缀由不同 RIR持有，预计最多只能几年保持未分配状态。［IP4R］ 是
一个关于当前IPv4 地址利用率的统计。

\section{参考文献}
［CGEMA］ Cisco Systems， "Guidelines for Enterprise IP Multicast Address

Allocation” 2004,http://www.cisco.com/warp/public/cc/techno/tity/prodlit/

ipmlt\_wp.df

［EIGRP］ B.Albrightson, JJ.Garcia-Luna-Aceves, and J. Boyle， "EIGRP-A Fast

Routing Protocol Based on Distance Vectors”" Proc. Infocom, 2004.

［EUI64］ Institute for Electrical and Electronics Engineers， "Guidelines for 64-Bit

Global Identifier （EUI-64） Registration Authority." Mar. 1997, http://standards.

ieee.org/regauth/oui/tutorials/EU164.html

［H96］ M. Handley， "The SDR Session Directory: An Mbone Conference Schedul-

ing and Booking System/' Department of Computer Science, University College

London, Apr. 1996,http://cobweb.ecn.purdue.edu/~ace/mbone/mbone/sdr/

intro.html

【ANA］ Internet Assigned Numbers Authority, http://www.iana.org

［IDChes］ S. Cheshire and M. Krochmal， “Multicast DNS，" Internet draft-

cheshire-dnsext-multicastdns, work in progress, Oct. 2010.

DDv4v6mc］ S. Venaas, X. Li, and C. Bao， "Framework for IPv4/IPv6 Multicast

Translation，" Internet draft-venaas-behave-v4v6mc-framework, work in progress，

Dec. 2010.

［IEEERAJ IEEE Registration Authority, http://standards.ieee.org/regauth

［LMIR02］ B. Edwards, L. Giuliano, and B. Wright, Interdomain Multicast Routing：

Practical Juniper Netroorks and Cisco Systems Solutions （Addison-Wesley, 2002）.

［IP4AS］ http://www.iana.org/assignments/ipv4-address-space

［IP4MA］ http://www.iana.org/assignments/multicast-addresses

［IP4R］ IPv4 Address Report, http://www.potaroo.net/tools /ipv4

［IP6AS］ http://www.iana.org/assignments/ipv6-address-space

［IP6MA］ http://www.iana.org/assignments/ipv6-multicastaddresses

［KK77］ L. Kleinrock and F. Kamoun， "Hierarchical Routing for Large Networks，

Performance Evaluation and Optimization" Computer Networks, 1（3）， 1977.

［NRO1 Number Resource Organization, http://www.nro.net