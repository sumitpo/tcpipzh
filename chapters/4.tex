\chapter{地址解析协议}
\minitoc

\section{引言}

IP 协议的设计目标是为跨越不同类型物理网络的分组交换提供互操作。这需要网络层软
件使用的地址和底层网络硬件使用的地址之间进行转换。网络接口硬件通常有一个主要的硬
件地址（例如以太网或802.11无线接口的48位地址）。由硬件交换的帧需要使用正确的硬件
地址定位到正确的接口；否则，无法传输数据。但是，一个传统IPv4 网络需要使用自己的
地址：32位的IPv4地址。如果一台主机要将一个帧发送到另一台主机，仅知道这台主机的
IP 地址是不够的，还需要知道主机在网络中的有效硬件地址。操作系统软件（即以太网驱动
程序）必须知道目的主机的硬件地址，以便直接向它发送数据。对于TCPAIP 网络，地址解
析协议（ARP）\href{https://www.rfc-editor.org/rfc/rfc0826}{[RFC0826]} 提供了一种在IPv4地址和各种网络技术使用的硬件地址之间的映
射。ARP仅用于IPv4，IPv6使用邻居发现协议，它被合并人ICMPv6（见第8章）。

这里需要注意的是，网络层地址和链路层地址是由不同部门分配的。对于网络硬件，主
地址是由设备制造商定义的，并存储在设备的永久性内存中，所以它不会改变。因此，工
作在特定硬件技术上的任意协议族，必须利用特定类型的地址。这允许不同协议族中的
网络层协议同时运行。另一方面，网络接口的IP地址是由用户或网络管理员分配的，并
且可以按需选择。为便携设备分配的IP地址可能改变，例如设备移动时。IP地址通常从
维护附近网络连接点的地址池中获得，它在系统启用或配置时分配（见第6章）。当两个
局域网的主机之间传输的以太网帧包含IP 数据报时，由48位以太网地址确定该帧的目的
接口。

地址解析是发现两个地址之间的映射关系的过程。对于使用IPv4的TCP/IP 协议族，这
是由运行的ARP来实现的。ARP 是一个通用的协议，从这个意义上来看，它被设计为支持
多种地址之间的映射。实际上，ARP 几乎总是用于32位IPv4 地址和以太网的48位MAC
地址之间的映射。这种情况在\href{https://www.rfc-editor.org/rfc/rfc0826}{[RFC0826]}中进行描述，它也是我们感兴趣的。在本章中，我
们将互换使用以太网地址和 MAC地址。

ARP 提供从网络层地址到相关硬件地址的动态映射。我们使用动态这个术语是因为它会
自动执行和随时间变化，而不需要系统管理员重新配置。也就是说，如果一台主机改变它的
网络接口卡，从而改变了它的硬件地址（但保留其分配的IP 地址），ARP 可以在一定延时后
继续正常运作。ARP操作通常与用户或系统管理员无关。

注意 提供 ARP反向映射的协议称为 RARP，它用于缺少磁盘驱动器（通常是无盘
工作站或X终端）的系统。它在当前已很少使用，而且需要系统管理员手动配置。
详情见\href{https://www.rfc-editor.org/rfc/rfc0903}{[RFC0903]}。

\section{一个例子}

当我们使用 Internet 服务时，例如在浏览器中打开一个网页，本地计算机必须确定如何
与相关的服务器联系。它首先是判断该服务位于本地（同一IP 子网的一部分）还是远程。如
果是远程的，需要一台可到达目的地的路由器。仅在到达位于同一IP子网的系统时，ARP
才能工作。那么，对于这个例子，我们假设使用Web 浏览器打开以下网址：

http://10.0.0.1

注意，这个 URL 包含一个 IPv4地址，而不是更常见的域名或主机名。这里使用地址的
原因是要强调一个事实，例子中是共享相同 IPv4 前缀的相关系统（见第2章）。这里，我们
使用包含地址的URL，以确定一个本地的Web 服务器，并探索直接交付的运行原理。随着
嵌入式设备（例如打印机和VoIP适配器）使用内置Web 服务器进行配置，这种本地服务器
越来越常见。

\section{直接交付和 ARP}

在本节中，我们列出了直接交付的步骤，重点集中在 ARP的运行上。直接交付发生在
一个IP数据报被发送到一个 IP地址，而该地址与发送方具有相同IP前缀的情况下。在IP
数据报转发（见第5章）的常见方式中，它扮演着一个重要角色。下面用前面的例子列出
IPv4 直接交付的基本操作：

1. 在这种情况下，应用程序是一个 Web 浏览器，调用一个特殊函数来解析 URL，看它
是否包含主机名。这里不是，应用程序使用32位IPv4 地址 10.0.0.1。

2. 应用程序要求TCP协议建立一条到10.0.0.1 的连接。

3.通过向10.0.0.1发送一个IPv4数据报，TCP 尝试向远程主机发送一个连接请求（第
15 章将介绍细节）。

4. 我们假设地址10.0.0.1使用与发送主机相同的网络前缀，数据报可被直接发送到这个
地址而不经过任何路由器。

5.假设以太网兼容地址被用于IPv4 子网，发送主机必须将32位的IPv4 目的地址转换
为48位的以太网地址。使用\href{https://www.rfc-editor.org/rfc/rfc0826}{[RFC0826]}的术语，就是需要从逻辑 Internet 地址向对应物理
硬件地址进行转换。这是 ARP功能。ARP工作在正常模式下，仅适用于广播网络，链路层
能将一个消息交付到它连接的所有网络设备。这是 ARP运行的一个重要要求。在非广播网
络（有时被称为非广播多路访问（NBMA））中，可能需要更复杂的映射协议\href{https://www.rfc-editor.org/rfc/rfc2332}{[RFC2332]}。

6.在一个共享的链路层网段上，ARP 向所有主机发送一个称为ARP 请求的以太网帧。
这被称链路层广播。图4-1的斜线阴影中显示了一个广播域。ARP 请求包含目的主机的
IPv4地址（10.0.0.1），并寻找以下问题的答案：“如果你将IPv4地址10.0.0.1 配置为自己的
地址，请向我回应你的 MAC地址。”

7.通过 ARP，同一广播域中的所有系统可接收 ARP请求。这包括可能根本不运行IPv4
或IPv6协议的系统，但不包括位于不同VLAN 中的系统，即使支持它们（VLAN详细信息
见第3章）。如果某个系统使用请求中指出的IPv4地址，它仅需要响应一个 ARP应答。这
个应答包含 IPv4 地址（与请求相匹配）和对应的MAC地址。这个应答通常不是广播，而是
仅直接发送给请求的发送方。同时，接收ARP请求的主机学习 IPV4到MAC地址的映射，
并记录在内存中供以后使用（见4.3节）。

8.ARP 应答被原始请求的发送方接收，现在可发送引起这次ARP 请求/应答交换过程

图4-1 以太网主机在同一广播域中。ARP 查询使用链路层广播帧发送，并被所有主机接收。IP地址
匹配的主机直接向请求主机返回响应。IP地址不匹配的主机主动丢弃ARP查询

9.发送方可将数据报封装在以太网帧中直接发送到目的主机，并使用由 ARP交换学到

的以太网地址作为目的地址。由于这个以太网地址仅指向正确的目的主机，所以其他主机或
路由器不会接收到这个数据报。因此，当仅使用直接交付时，并不需要经过路由器。

ARP用于运行IPv4 的多接人链路层网络，每个主机都有自己首选的硬件地址。点到点

链路（例如 PPP）不使用ARP（见第3章）。当这些链路被建立后（通常是由用户或系统来发
起创建），在链路两端通知正在使用的地址。由于不涉及硬件地址，因此不需要地址解析或
ARP。

\section{ARP缓存}

ARP高效运行的关键是维护每个主机和路由器上的ARP缓存（或表）。该缓存使用地
址解析为每个接口维护从网络层地址到硬件地址的最新映射。当IPv4地址映射到硬件地址
时，它对应于高速缓存中的一个条目，其正常到期时间是条目创建开始后的20分钟，这在
\href{https://www.rfc-editor.org/rfc/rfc1122}{[RFC1122]}中描述。

我们可在Linux 或 Windows 中使用 arp 命令查看ARP缓存。选项-a用于显示这两个系
统的缓存中的所有条目。在 Linux 中，运行 arp 会产生以下输出：

\begin{verbatim}
    
Linux& arp

Address

gw.home

printer.home

Wtype

ether

ether

HWaddress

00:OD:66:4F:60:00

00:0A:95:87:38:6A

C

C

Flags Mask Iface

eth1

ethl

Linux8 arp

一a

printer.home（10.0.0.4）at

00:0A:95:87:38:6A ［ether］on eth1

gw.home （10.0.0.1）

at 00:0D:66:4F:60:00 ［ether］ on eth1

在 Windows 中，运行 arp 会产生以下类似的输出：

c：> arp -a

Interface: 10.0.0.56 --- 0x2

Internet Address

10.0.0.1

10.0.0.4

Physical Address

00-0d-66-4£-60-00

00-0a-95-87-38-6a

TyPe

dynamic

dynamic
\end{verbatim}

这里，我们看到的是IPv4到硬件地址的缓存。在第一个（Linux）例子中，每个映射是
一个包含5个元素的条目：主机名（对应一个IP 地址）、硬件地址类型、硬件地址、标志和
本地网络接口（它对于这个映射是活跃的）。标志列包含一个符号：C、M或P。C类条目由
ARP协议动态学习，M类条目通过手工输人（arp -s；见4.9节），而P类条目的含义是“发
布”。也就是说，对于任何P类条目，主机对输入的ARP 请求返回一个 ARP 应答。这个选
项用于配置代理 ARP（见4.7节）。第二个 Linux 的例子显不了使用

！“BSD 风格”的类似信息。

这里，给出了主机名和地址，对应的地址类型（［ether］表示一个以太网类型的地址），以及映
射活跃在哪个接口上。

Windows 的arp 程序显示了接口的IPv4地址，它的接口号是十六进制数（这里的0x2）。

Windows 版本还指出地址是手动输人还是 ARP 学习。在这个例子中，两个条目都是动态的，
这意味着它们来自 ARP学习（如果通过手工输人，它们是静态的）。注意，48位MAC地址
被显为6个十六进制数，在Linux 中使用冒号分隔，在Windows 中使用短杠（dash）分隔。
在传统上，UNIX系统一直使用冒号，而IEEE 标准和其他操作系统倾向于使用短杠。我们
在4.9节中讨论 arp 命令的附加功能和其他选项。

\section{ARP 帧格式}

图4-2显示了在以太网中转换一个 IPv4地址时常用的 ARP 请求和应答分组的格式（正如
前面所说，ARP通常也能用于IPv4以外的地址，虽然这是非常少见的）。前14字节构成标准
的以太网头部，假设没有802.1p/q 或其他标记，其余部分由 ARP协议来定义。ARP 帧的前8
个字节是通用的，这个例子中的剩余部分专门用于将IPv4地址映射到48位的以太网地址。

图4-2 IPv4地址映射到48位的MAC（以太网）地址时使用的ARP帧格式

在图4-2所示的ARP 帧的以太网头部中，前两个字段包含目的和源以太网地址。对于
ARP 请求，目的以太网地址 ff:ff:f:ff:ff.ff（全部为1）是广播地址，在同一广播域中的所有
以太网接口可接收这些帧。在以太网帧中，对于 ARP（请求或应答），2字节的长度或类型字
段必须为0x0806。

长度/ 类型字段之后的前4个字段指定了最后4个字段的类型和大小。这些值由IANA
\href{https://www.rfc-editor.org/rfc/rfc5494}{[RFC5494]}来指定。术语硬件和协议用于描述 ARP 分组中的字段。例如，一个ARP 请求询
问协议地址（在这种情况下是IPv4地址）对应的硬件地址（在这种情况下是以太网地址）。
这些术语很少被用于 ARP 之外。相对来说，硬件地址的常见术语有MAC、物理或链路层地
址（或以太网地址，当网络基于 IEEE 802.3/以太网的一系列规范时）。硬件类型字段指出硬
件地址类型。对于以太网，该值为1。协议类型字段指出映射的协议地址类型。对于IPv4地
址，该值为Ox0800。当以太网帧包含 IPv4数据报时，这可能与以太网帧的类型字段值一致。

对于下面两个1字节的字段，硬件大小和协议大小分别指出硬件地址和协议地址的字节数。

对于以太网中使用IPv4地址的ARP 请求或应答，它们的值分别为6和4。Op 字段指出该操
作是ARP 请求（值次1）、ARP应答（2）、RARP 请求（3）或RARP应答（4）。由于 ARP
请求和 ARP应答的长度/ 类型字段相同，因此这个字段是必需的。

紧跟在后面的4个字段是发送方硬件地址（在这个例子中是以太网 MAC地址）、发送
方协议地址（IPv4地址）、目的硬件地址（MAC/ 以太网地址）和目的协议地址（IPv4地址）。

注意，这里存在一些重复的信息：以太网头部和 ARP 消息都包含发送方硬件地址。对于一
个 ARP请求，除了目的硬件地址（设为0）之外，其他字段都需要填充。当一个系统接收到
一个 ARP 请求，它填充自己的硬件地址，将两个发送方地址和两个接收方地址互换，将Op
字段设置为2，然后发送生成的应答。

\section{ARP 例子}

在本节中，我们将使用tcpdump 命令查看在执行一个正常的 TCPAIP 应用（例如 Telnet）
时运行 ARP所实际发生的过程。Telnet 是一个简单的应用程序，可用于在两个系统之间建立
一条 TCP/IP连接。

\subsection{正常的例子}

为了查看ARP运行，我们将执行 telnet 命令，使用TCP端口80（称为www）连接到主
机10.0.0.3上的Web 服务器。

\begin{verbatim}
    
C：\> arp -a

No ARP Entries Found

C：\> telnet 10.0.0.3

wWW

验证ARP缓存为空

连接到Web服务器［端口80］

Connecting

to 10.0.0.3...

Escape character is '^］'.

按下 CTRL +右括号键获得 Telnet 客户机的提示。

UO'SOBTM MMM

Welcome to Microsoft Telnet Client

Escape Character is

'CTRL+］'

Microsoft Telnet> quit
\end{verbatim}

指令 quit用于退出程序。

在这些命令执行的同时，我们在另一个系统上运行 tcpdump 命令，并观察交换的流量信
息。使用-e选项可以显示 MAC地址（这个例子中是48位以太网地址）。

下面列出的内容包含来自tcpdump 的输出。我们删除了输出的最后4行，它们用于终止
连接（我们将在第13章中详细讨论），但与这里的讨论无关。注意，不同系统中的 tcpdump
版本提供的输出细节可能稍有不同。

\begin{verbatim}
    
Linux#

0.0 0:0:c0:6f:2d:40 ff:ff:ff:ff:ff:ff arp 60：

arp who-has 10.0.0.3 tell

10.0.0.56

2

0.002174（0.0022）0:0:c0:c2:9b:26 0:0:c0:6f:2d:40 arp 60：

arp reply 10.0.0.3 is-at 0:0:c0:c2:9b:26

3

0.002831（0.0007）0:0:c0:6f:2d:40 0:0:c0:c2:9b:26 ip

10.0.0.56.1030 > 10.0.0.3.wWw: S 596459521:596459521（0）

win 4096 <mss 1024>［tos 0x10］

4

（0.0050）0:0:c0:c2:9b:26 0:0:c0:6f:2d:40 ip 60：

10.0.0.3.www > 10.0.0.56.1030:S 3562228225:3562228225（0）

ack 596459522 win 4096 <mss

5

0.009615（0.0018）0:0:c0:6f:2d:40 0:0:c0:c2:9b:26 ip

10.0.0.56.1030 > 10.0.0.3.discard：

• ack 1 win 4096 ［tos 0x10］
\end{verbatim}

在分组1中，源硬件地址为 0:0:c0:6f:2d:40。目的硬件地址为ff:ff:ff:ff:ff:f，它是一个
以太网广播地址。同一广播域（在同一局域网或 VLAN 中的所有主机，无论它们是否运行
TCP/IP）中的所有以太网接口接收并处理该帧，如图4-1所示。分组1的下一个输出字段为
arp，意味着帧类型字段Ox0806，表明它是 ARP 请求或ARP应答。在前5个分组中，arp
和 ip后面打印的值60是以太网帧的长度。ARP 请求或ARP 应答的大小是42字节（ARP 消
息为28字节，以太网头部为14字节）。每个帧均填充为最小以太网帧：60字节数据和4字
节CRC（见第3章）。

分组1的下一部分（即 arp who-has）用于标识该帧是ARP 请求，目的地址是IPv4地址
10.0.0.3，源地址是 IPv4地址 10.0.0.56。tcpdump 显示默认IP 地址对应的主机名，但在这里
没有显示（由于没有为它们建立反向DNS映射；第11 章介绍 DNS的细节）。接下来，我们
使用-n 选项查看 ARP 请求中的IP 地址，无论它们是否进行 DNS 映射。

我们从分组2中看到，虽然ARP 请求是广播的，但ARP应答的目的地址是（单播）
MAC地址 0:0:c0:6f:2d:40。因此，ARP应答是直接发送到请求主机，它并不是通常的广播
（在4.8节的一些情况下，这个规则可能会改变）。tcpdump 显示出该帧的ARP应答，以及响
应者的IPv4地址和硬件地址。第3行是请求建立连接的第一个TCP 段。其目的硬件地址属
于目的主机（10.0.0.3）。我们将在第13章涉及这部分的细节。

对于每个分组，分组号后面的数字是 tcpdump 接收分组时的相对时间（秒）。除第一个
之外的每个分组都包含从前一时间到现在的时间差（秒），该值放在括号中。我们可看到发
送ARP 请求和接收 ARP应答之间的时间约为2.2ms。第一个TCP 段在此后0.7ms发送。在
这个例子中，ARP 动态地址解析的开销少于3ms。注意，如果主机 10.0.0.3的ARP表项在
10.0.0.56的ARP缓存中是有效的，最初的ARP 交换并不会发生，最初的TCP段可能已使
用目的以太网地址立即发送。

有关tcpdump 输出的一个微妙问题是，在向10.0.0.56（第4行）发送自己的第一个 TCP
段之前，我们没看到来自 10.0.0.3的ARP 请求。10.0.0.3在自己的ARP缓存中可能已有一个
10.0.0.56 的条目，通常当系统接收到发送给它的 ARP 请求时，除了发送 ARP 应答外，它还
会在ARP缓存中保存请求者的硬件地址和IP 地址。这是一个基于逻辑假设的优化，如果请
求者发送一个数据报，该数据报的接收者可能发送一个应答。

\subsection{对一个不存在主机的 ARP请求}

如果 ARP 请求中指定的主机关闭或不存在，将会发生什么？为了查看这种情况，我们
尝试访问一个不存在的本地IPv4地址，其前缀对应本地子网，但没有主机使用该地址。在
这个例子中，我们使用IPv4地址10.0.0.99。

\begin{verbatim}
    
Linux&

date ; telnet 10.0.0.99 i date

Fri Jan 29 14:46:33 PST 2010

Trying 10.0.0.99.••

telnet: connect to address 10.0.0.99: No route to host

Fri Jan 29 14:46:36 PST 2010

3s after previous date

Linux8 arp -a

？ （10.0.0.99）at <incomplete> on etho
\end{verbatim}
这是 tcpdump 的输出：
\begin{verbatim}
Linux# tcpdump -n arp

1 21:12:07.440845 arp who-has 10.0.0.99 tel1 10.0.0.56

2 21:12:08.436842 arp who-has

.10.0.0.99 tell 10.0.0.56

3 21:12:09.436836 arp who-has

10.0.0.99 tel1 10.0.0.56
\end{verbatim}

由于我们已知使用广播地址发送ARP 请求，因此本次并没有指定-e选项。ARP 请求的
频率接近每秒一次，这是\href{https://www.rfc-editor.org/rfc/rfc1122}{[RFC1122]}建议的最大值。Windows 系统中（没有给出图示）的测
试显示出不同的行为。不是3个请求之间各间隔1秒，而是根据使用的应用程序或其他协议
改变间隔。对于ICMP 和UDP（分别见第8 章和第10章），使用的间隔约为5秒，而TCP使
用的间隔10秒。对于TCP，在TCP放弃尝试建立一条连接之前，10秒间隔足以发送2个
无须应答的 ARP 请求。

\section{ARP缓存超时}

超时通常与 ARP缓存中的每个条目相关（我们在后面将会看到，arp 命令允许管理员设
置缓存条目永远不超时）。在大多数实现中，完整条目的超时为20分钟，而不完整条目的
超时为3分钟（我们在前面的例子中看到一个不完整条目，它强迫执行一次到不存在主机的
ARP 请求）。这些实现通常在每次使用一个条目后为它重新启动20分钟的超时。\href{https://www.rfc-editor.org/rfc/rfc1122}{[RFC1122]}
是描述主机需求的RFC，它规定每个条目即使在使用也应启动超时，但很多实现并不这样
做，它们在每次使用条目后重新启动超时。

注意，这是关于软状态的一个重要例子。软状态是指在超时到达前没有更新而被丢弃
的信息。如果网络条件发生改变，软状态有助于启动自动重新配置，因此很多 Internet 协议
使用软状态。软状态的成本是协议必须刷新状态以避免过期。在一些协议设计中，经常包括
“软状态刷新”，以保持软状态的活跃。

\section{代理 ARP}

代理 ARP\href{https://www.rfc-editor.org/rfc/rfc1027}{[RFC1027]}使一个系统（通常是一台专门配置的路由器）可回答不同主机的
ARP请求。它使ARP请求的发送者认为做出响应的系统就是目的主机，但实际上目的主机
可能在其他地方（或不存在）。ARP代理并不常见，通常应尽量避免使用它。

代理 ARP 也被称为混杂 ARP或ARP 黑客。这些名称来自 ARP代理的历史用途：两个
物理网络相互隐蔽自己。在这种情况下，两个物理网络可使用相同的IP前缀，只要将中间的
路由器配置为一个代理ARP，在一个网络中由代理响应对其他网络中主机的ARP 请求。这
种技术可用于向一组主机隐藏另一组主机。从前，这样做有两个常见原因：有些系统无法进
行子网划分，有些系统使用比较旧的广播地址（全0的主机ID，而不是当前的全1的主机
ID）。

Linux 支持一种称为自动代理 ARP的功能。它可通过在文件 /proc/sys/net/ipv4/conf/*/
proxy\_arp 中写人学符1，或使用sysctl 命令来启用。它支持使用代理 ARP功能，而不必为
被代理的每个可能的IPv4 地址手工输入 ARP条目。这样做允许自动代理一个地址范围，而
不是单个地址。

\section{免费 ARP 和地址冲突检测}

ARP的另一个功能被称免费 ARP。它发生在一台主机发送 ARP请求以寻找自己的地
址时。它通常出现在启动时，当接口被配置为“上行”时常这样做。下面是一个例子，在一
台 Linux 机器上跟踪显示 Windows 主机的启动：

\begin{verbatim}
    
Linux#

tcpaump -e -n arp

1

0.00:0:c0:6f:2d:40 Ef:ff:ff:ff:ff:ff arp 60：

arp who-has 10.0.0.56 tel1 10.0.0.56
\end{verbatim}

（我们为tcpdump 增加-n 标志，以打印数字化的点分十进制地址而不是主机名。）就
ARP 请求字段而言，发送方协议地址和目的协议地址相同：10.0.0.56。另外，以太网头部中
的源地址字段被 tcpdump 显示 0:0:c0:6f:2d:40，它等于发送方硬件地址。免费 ARP 需要达
到两个目标：

1.允许一台主机确定另一台主机是否配置相同的IPv4地址。发送免费ARP 的主机并不
期望它的请求获得应答。但是，如果它接收到一个应答，通常显示的是错误消息“从以太网
地址•⋯发送的重复IP 地址”。这是对系统管理员和用户的警告，在同一广播域（例如局域
网或 VLAN）中有一个系统配置出错。

2. 如果发送免费ARP的主机已改变硬件地址（关闭主机或替换接口卡，然后重新启动
主机），该帧导致任何接收广播并且其缓存中有该条目的其他主机，将该条目中的旧硬件地
址更新为与该帧一致。如前面所述，如果一台主机接收到一个 ARP 请求，该请求来自一个
已存在接收方缓存中的IPv4地址，则缓存条目更新为ARP 请求中发送方的硬件地址。这由
接收到 ARP 请求的主机完成，免费 ARP 正好利用这个特性。

虽然免费 ARP提供的一些迹象显示，多个站可尝试使用相同IPv4地址，但它实际上没
有对这种情况提供解决机制（除了显示一个消息，实际由系统管理员完成）。为了解决这个
问题，\href{https://www.rfc-editor.org/rfc/rfc5227}{[RFC5227]}描述了IPv4地址冲突检测（ACD）。ACD定义了 ARP 探测分组和 ARP通
告分组。ARP探测分组是一个 ARP请求分组，其中发送方协议（IPv4）地址字段被设置为0。
探测分组用于查看一个候选IPv4 地址是否被广播域中的任何其他系统所使用。通过将发送
方协议地址字段设置为0，避免候选IPv4 地址被另一台主机使用时的缓存污染，这是它与免
费ARP工作方式的一个差别。ARP通告与 ARP探测相同，除了其发送方协议地址和目的协
议地址字段被填充为候选IPv4 地址外。它用于通告发送方使用候选IPv4地址的意图。

为了执行 ACD，当一个接口被启用或从睡眠中唤醒，或一个新链路建立（例如，当一个
新的无线网络关联建立）时，这台主机发送一个 ARP探测分组。在发送3个探测分组之前，
首先需要等待一个随机时间（范围为0~1秒，均匀分布）。当多个系统同时启用时，通过
延迟来避免启用带来的拥塞，否则都立即执行 ACD，这将导致网络流量激增。探测分组之
间存在一个随机的时间间距，大约1 ~2秒的延迟（均匀分布）。

当请求站发送自己的探测时，它可能接收到 ARP 请求或应答。对其探测的应答表明其
他站已使用候选IP地址。从不同系统发送的请求，其目的协议地址字段中包含相同的候选
IPv4 地址，表明其他系统也在同时尝试获得候选IPv4地址。在这两种情况下，该系统将会
显示一个地址冲突消息，并采用其他可选地址。例如，当使用DHCP（见第6章）分配地址
时，这是推荐的行为。\href{https://www.rfc-editor.org/rfc/rfc5227}{[RFC5227]}对尝试获得地址设置了10次的冲突限制，在请求的主机
进入限速阶段之前，它被允许每60秒执行一次 ACD，直至成功。

根据前面所描述的过程，如果发送请求的主机没有发现冲突，它会间隔2秒向广播域中
发送2个 ARP通告，以表明它现在使用这个 IPv4地址。在这个通告中，发送方协议地址和
目的协议地址字段被设置为其声称的地址。发送这些通告的目的是确保更新缓存地址映射，
以正确反映发送方当前使用的地址。

ACD 被认为是一个持续的过程，这是它与免费ARP 的区别。当一台主机通告它正使用
的地址后，它会继续检查输人的ARP 流量（请求和应答），查看自己的地址是否出现在发送
方协议地址字段中。如果是的话，说明其他系统与自己在使用相同的地址。在这种情况下，
\href{https://www.rfc-editor.org/rfc/rfc5227}{[RFC5227]}提供了3种可能的解决方案：停止使用这个地址；保留这个地址，但发送一个“防
御性”ARP通告，如果冲突继续，则停止使用它；不理会冲突，仍继续使用。对于最后一个
选择，仅建议那些真正需要一个固定、稳定地址的系统（例如打印机或路由器等嵌人式设备）
使用。

\href{https://www.rfc-editor.org/rfc/rfc5227}{[RFC5227]}还说明了使用链路层广播发送ARP应答的潜在好处。虽然这不是传统的
ARP 工作方式，但同一网段中所有站需处理 ARP流量时，这样做可带来一些好处。广播应
答可以更快地执行 ACD，这是由于所有站都会注意到这个应答，并在发现冲突时使自己的
缓存无效。

\section{arp 命令}

在 Windows 和 Linux 中，我们使用带有-a标志的arp 命令显示ARP缓存中的所有条目
（在Linux上，我们可不使用-a而获得类似信息）。超级用户或管理员可指定-d选项来删除
ARP缓存中的条目（这在运行一些例子前用于强制执行一次 ARP交换。）

我们也可以使用-s选项增加条目。它需要一个IPv4地址（或使用DNS从IPv4地址转
换的主机名）和一个以太网地址。这个IPv4 地址和以太网地址作为一个条目被添加在缓存
中。这个条目是半永久性的（即它在缓存中不会超时，但在系统重启时消失）。

Linux 版本的arp 比 Windows 版本提供更多功能。当在命令行结尾使用关键字 temp，并
使用-s增加一个条目时，这个条目被认为是临时的，并与其他ARP条目一样会超时。当在
命令行结尾使用关键字 pub 并使用-s时，系统对该条目做出 ARP应答。系统对 ARP 请求的
IPv4 地址以相应的以太网地址来应答。如果通告地址是系统自己的地址之一，该系统可作为
一个指定IPv4地址的代理ARP（见4.7节）。如果 arp -s用于启用代理 ARP，Linux 对指定
地址做出应答，在/proc/sys/net/ipv4/conf/*/ proxy\_arp 文件中写人0。

\section{使用 ARP设置一台嵌入式设备的IPV4 地址}

随着越来越多的嵌入式设备与以太网、TCP/IP 协议兼容，那些无法直接输入网络配置信
息的联网设备越来越普遍（例如，它们没有键盘，难以输入自己使用的IP地址）。这些设备
通常采用以下两种方式之一配置：一种是使用DHCP 自动分配地址和其他信息（见第6章）；
另一种是使用ARP 设置IPv4地址，虽然这种方法并不常见。

通过ARP为嵌人式设备配置IPv4地址不是协议的初衷，这是由于它不是完全自动的。

它的基本思路是为设备手动建立一个 ARP 映射（使用arp -s命令），然后向这个地址发送一
个IP 分组。由于相应 ARP条目已存在，因此不会产生 ARP请求/ 应答。相反，硬件地址可
以立即使用。当然，设备的以太网（MAC）地址必须已知。它通常印在设备上，有时兼作制
造商的设备序列号。当设备接收到一个目标为自身硬件地址的分组时，这个数据报包含的目
的地址用于指定其初始IPv4地址。此后，这台设备可用其他方式（例如通过一个嵌人式Web
服务器）完成配置。

\section{与ARP相关的攻击}

目前已有一系列涉及 ARP的攻击。最直接的是使用代理ARP功能假扮主机，对ARP
请求做出应答。如果受害主机不存在，这很直观，而且可能难以发现。如果该主机仍在运
行，这被认为更困难，因为每个 ARP请求可能有多个应答，这样比较容易发现。

一种更巧妙的攻击可被 ARP触发，它涉及一台主机被连接到多个网络，并且一个接口
的ARP条目被其他 ARP表“遗漏”的情况，这是由 ARP 软件的一个错误造成的。利用这种
漏洞可将流量引导到错误网段上。Linux 提供了一个直接影响该行为的方式，可通过修改文
件/proc/sys/net/ipv4/conf/*/arp\_filter 实现。如果将数值1写入这个文件，当输人的ARP请
求到达一个接口时，就进行一次IP 转发检查。这时需要查找请求者的IP 地址，以确定哪个
接口将用于发送返回的IP数据报。如果到达的ARP请求与返回发送方的IP 数据报使用不同
的接口，这个 ARP应答被抑制（触发它的 ARP 请求被丢弃）。

更具破坏性的ARP攻击涉及静态条目处理。如前所述，当查找对应一个特定IP地址的
以太网（MAC）地址时，静态条目可用于避免ARP 请求/应答。这种条目已被用于尝试增
强安全性。它的思路是在 ARP缓存中对重要主机使用静态条目，以快速检测任何针对该IP
地址的主机欺骗。不幸的是，大多数ARP实现通常用ARP应答提供的条目代替静态缓存条
目。这样的后果是，接收到ARP应答（即使它没发送ARP请求）的主机被欺骗，并使用攻
击者提供的条目代替自己的静态条目。

\section{总结}

ARP是TCP/IP 实现中的一个基本协议，但它通常在应用程序或用户没有察觉的情况下
运行。ARP用于确定本地可达的IPv4 子网使用的IPv4地址对应的硬件地址。它在数据报的
目的地与发送方处于同一子网时使用，还用于数据报的目的地不在当前子网（在第5章详细
说明）时将其转发到一台路由器。ARP缓存是其运行的基础，我们可使用arp 命令查看和处
理缓存。缓存中每个条目都有一个计时器，用于清除不完整的条目和完整的条目。arp 命令
可显示和修改 ARP缓存中的条目。

我们深人了解特殊 ARP的正常运行：代理 ARP（一台路由器回答主机通过另一台路由
器接口访问的ARP 请求）和免费ARP（发送自己拥有的IP 地址的ARP请求，通常用于引
导）。我们还讨论了IPv4地址冲突检测，采用一种持续运行的类似免费ARP的交换，来避
免在同一广播域中地址重复。最后，我们讨论了一系列涉及 ARP的攻击。如果高层协议没
有强大的安全措施，这可能会导致高层协议出现问题（见第18章）。

\section{参考文献}
